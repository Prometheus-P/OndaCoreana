---
import BaseLayout from '../layouts/BaseLayout.astro';
import SearchInput from '../components/search/SearchInput.astro';
import SearchFilters from '../components/search/SearchFilters.astro';
import type { ContentType } from '../types/search';

const title = 'Buscar | OndaCoreana';
const description = 'Busca contenido sobre K-Dramas, K-Pop, noticias y guías de cultura coreana en español.';
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://ondacoreana.com';
const allowedFilters: ContentType[] = ['all', 'dramas', 'kpop', 'noticias', 'guias'];

const url = Astro.url;
const rawQuery = url.searchParams.get('q') ?? '';
const normalizedQuery = rawQuery.trim().slice(0, 100);
const requestedFilter = (url.searchParams.get('type') ?? 'all') as ContentType;
const initialFilter = allowedFilters.includes(requestedFilter) ? requestedFilter : 'all';
const canonical = `${siteUrl}${url.pathname}${url.search}`;
const pageTitle = normalizedQuery ? `Buscar “${normalizedQuery}” | OndaCoreana` : title;
const shouldNoIndex = normalizedQuery.length === 0;
---

<BaseLayout title={pageTitle} description={description} noindex={shouldNoIndex} canonical={canonical} showSearch={false}>
  <main
    id="main-content"
    class="min-h-screen"
    style="background: color-mix(in srgb, var(--md-color-surface) 90%, var(--md-color-surface-container)); padding: var(--md-spacing-3xl) 0;"
    data-search-page
    data-initial-query={normalizedQuery}
    data-initial-filter={initialFilter}
  >
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 space-y-8">
      {/* Page header */}
      <div class="space-y-3">
        <p class="chip" style="--chip-bg: color-mix(in srgb, var(--md-color-primary) 18%, transparent); --chip-color: var(--md-color-on-primary-container); width: fit-content;">
          Buscar
        </p>
        <h1 class="text-4xl font-bold" style="color: var(--md-color-on-surface); font-family: var(--md-typo-font-family);">
          Encuentra contenido de OndaCoreana
        </h1>
        <p class="text-lg" style="color: var(--md-color-on-surface-variant);">
          Explora reseñas de K-Dramas, perfiles de K-Pop, noticias y guías en un solo lugar.
        </p>
      </div>

      {/* Search input */}
      <div class="surface-card" style="padding: var(--md-spacing-xl); background: var(--md-color-surface-container-low);">
        <SearchInput
          placeholder="Buscar K-Dramas, K-Pop, noticias..."
          size="lg"
          initialValue={normalizedQuery}
          showInlineResults={false}
        />
        <p id="truncation-warning" class="hidden" style="margin-top: var(--md-spacing-sm); color: #b45309; font-size: var(--md-typo-label-medium-size);">
          La búsqueda se ha limitado a 100 caracteres.
        </p>
      </div>

      {/* Filter tabs */}
      <div class="surface-card" style="padding: var(--md-spacing-lg); background-color: var(--md-color-surface-container-low);">
        <SearchFilters activeFilter={initialFilter} query={normalizedQuery} />
      </div>

      {/* Results section - dynamically rendered by client-side JS */}
      <div
        id="search-results-container"
        class="space-y-4"
        aria-live="polite"
        aria-busy="true"
      ></div>
    </div>
  </main>
</BaseLayout>

<style>
  .search-results {
    display: flex;
    flex-direction: column;
    gap: var(--md-spacing-lg);
  }

  .result-count {
    font-size: var(--md-typo-body-medium-size);
    color: var(--md-color-on-surface-variant);
  }

  .search-result-card__link {
    display: flex;
    gap: var(--md-spacing-md);
    border-radius: var(--md-shape-xl);
    border: 1px solid color-mix(in srgb, var(--md-color-outline-variant) 80%, transparent);
    background-color: var(--md-color-surface-container-low);
    box-shadow: var(--md-elevation-1);
    transition: border-color var(--md-motion-duration-short) var(--md-motion-easing-standard), transform var(--md-motion-duration-short) var(--md-motion-easing-standard), box-shadow var(--md-motion-duration-short) var(--md-motion-easing-standard);
    padding: var(--md-spacing-md);
    color: inherit;
    text-decoration: none;
  }

  .search-result-card__link:hover {
    border-color: var(--md-color-primary);
    transform: translateY(-2px);
    box-shadow: var(--md-elevation-2);
  }

  .search-result-card__media img {
    border-radius: var(--md-shape-lg);
    object-fit: cover;
    width: 96px;
    height: 96px;
  }

  @media (max-width: 640px) {
    .search-result-card__media img {
      width: 72px;
      height: 72px;
    }
  }

  .search-result-chip {
    border-radius: var(--md-shape-full);
    padding: var(--md-spacing-xs) var(--md-spacing-sm);
    font-size: var(--md-typo-label-medium-size);
    font-weight: 600;
  }

  .search-result-chip[data-variant="dramas"] {
    background-color: var(--md-color-primary-container);
    color: var(--md-color-on-primary-container);
  }

  .search-result-chip[data-variant="kpop"] {
    background-color: var(--md-color-tertiary-container);
    color: var(--md-color-on-tertiary-container);
  }

  .search-result-chip[data-variant="noticias"] {
    background-color: var(--md-color-secondary-container);
    color: var(--md-color-on-secondary-container);
  }

  .search-result-chip[data-variant="guias"],
  .search-result-chip[data-variant="all"] {
    background-color: color-mix(in srgb, var(--md-color-primary) 12%, var(--md-color-surface-variant));
    color: var(--md-color-on-surface);
  }

  .search-result-title {
    font-size: var(--md-typo-title-medium-size);
    font-weight: 600;
    color: var(--md-color-on-surface);
    margin: 0;
  }

  .search-result-excerpt {
    font-size: var(--md-typo-body-medium-size);
    color: var(--md-color-on-surface-variant);
    margin: var(--md-spacing-xs) 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-result-date {
    font-size: var(--md-typo-label-medium-size);
    color: color-mix(in srgb, var(--md-color-on-surface-variant) 80%, transparent);
  }

  .search-empty {
    border-radius: var(--md-shape-xl);
    border: 1px dashed color-mix(in srgb, var(--md-color-outline) 80%, transparent);
    padding: var(--md-spacing-2xl);
    background-color: color-mix(in srgb, var(--md-color-surface-variant) 30%, transparent);
    text-align: center;
    color: var(--md-color-on-surface);
  }

  .search-empty h3 {
    font-size: var(--md-typo-title-medium-size);
    margin-bottom: var(--md-spacing-sm);
  }

  .search-empty p {
    color: var(--md-color-on-surface-variant);
  }

  .search-highlight {
    background-color: color-mix(in srgb, var(--md-color-primary) 25%, transparent);
    border-radius: var(--md-shape-sm);
    padding: 0 var(--md-spacing-xxs, 0.125rem);
  }

  #load-more-container {
    margin-top: var(--md-spacing-lg);
  }
</style>

<script>
  import { escapeHtml, escapeRegex, highlightMatch } from '../utils/search-client';

  // Type definitions for client-side use
  type ContentType = 'all' | 'dramas' | 'kpop' | 'noticias' | 'guias';

  interface SearchResult {
    title: string;
    excerpt: string;
    url: string;
    contentType: ContentType;
    pubDate: Date;
    heroImage?: string;
    relevanceScore: number;
  }

  // Pagefind types (inline for browser runtime)
  interface PagefindResultMeta {
    title?: string;
    description?: string;
    contentType?: string;
    pubDate?: string;
    heroImage?: string;
  }

  interface PagefindResultData {
    url: string;
    excerpt: string;
    meta: PagefindResultMeta;
  }

  interface PagefindResult {
    id: string;
    score: number;
    data: () => Promise<PagefindResultData>;
  }

  interface PagefindSearchResponse {
    results: PagefindResult[];
  }

  interface PagefindSearchOptions {
    filters?: Record<string, string | string[]>;
  }

  interface PagefindInstance {
    init: () => Promise<void>;
    search: (query: string, options?: PagefindSearchOptions) => Promise<PagefindSearchResponse>;
  }

  // Store pagefind instance globally
  let pagefindInstance: PagefindInstance | null = null;

  // Pagination state
  let currentSearchResults: PagefindResult[] = [];
  let currentQuery = '';
  let displayedCount = 0;
  const RESULTS_PER_PAGE = 10;

  // Get pagefind instance (lazy load once)
  async function getPagefind() {
    if (!pagefindInstance) {
      const pagefindPath = '/pagefind/pagefind.js';
      pagefindInstance = await import(/* @vite-ignore */ pagefindPath);
      await pagefindInstance.init();
    }
    return pagefindInstance;
  }

  // Load more results (pagination)
  async function loadMoreResults(container: HTMLElement, query: string) {
    const startIndex = displayedCount;
    const endIndex = Math.min(startIndex + RESULTS_PER_PAGE, currentSearchResults.length);
    const hasMore = endIndex < currentSearchResults.length;

    // Load result data for the current page
    const resultsData = await Promise.all(
      currentSearchResults.slice(startIndex, endIndex).map((result) => result.data())
    );

    // Transform to our SearchResult type
    const results: SearchResult[] = resultsData.map((data, index) => ({
      title: data.meta?.title || 'Sin título',
      excerpt: data.excerpt || data.meta?.description || '',
      url: data.url,
      contentType: (data.meta?.contentType as ContentType) || 'all',
      pubDate: data.meta?.pubDate ? new Date(data.meta.pubDate) : new Date(),
      heroImage: data.meta?.heroImage,
      relevanceScore: currentSearchResults[startIndex + index]?.score || 0,
    }));

    displayedCount = endIndex;

    if (startIndex === 0) {
      // Initial render
      container.innerHTML = renderSearchResults(results, currentSearchResults.length, query, hasMore);
    } else {
      // Append more results
      const resultsContainer = container.querySelector('.space-y-4');
      if (resultsContainer) {
        resultsContainer.insertAdjacentHTML('beforeend', results.map(result => renderResultCard(result, query)).join(''));
      }
      // Update or remove load more button
      const loadMoreContainer = container.querySelector('#load-more-container');
      if (loadMoreContainer) {
        if (hasMore) {
          loadMoreContainer.innerHTML = renderLoadMoreButton();
        } else {
          loadMoreContainer.remove();
        }
      }
    }

    // Attach click handler to load more button
    const loadMoreBtn = container.querySelector('#load-more-btn');
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => loadMoreResults(container, query));
    }
  }

  // Update SEO meta tags dynamically based on query
  function updateSEOMetaTags(query: string, resultCount: number = 0) {
    const siteUrl = window.location.origin;
    const hasValidQuery = query.length >= 2;

    // Helper to update or create meta tag
    function setMetaTag(selector: string, attribute: string, value: string) {
      let tag = document.querySelector(selector) as HTMLMetaElement | HTMLLinkElement | null;
      if (tag) {
        if (attribute === 'content') {
          (tag as HTMLMetaElement).content = value;
        } else if (attribute === 'href') {
          (tag as HTMLLinkElement).href = value;
        }
      }
    }

    if (hasValidQuery) {
      const newTitle = `Resultados para "${query}" | Buscar | OndaCoreana`;
      const newDescription = `${resultCount} resultado${resultCount !== 1 ? 's' : ''} encontrado${resultCount !== 1 ? 's' : ''} para "${query}" en OndaCoreana. Explora K-Dramas, K-Pop, noticias y guías.`;
      const canonicalUrl = `${siteUrl}/buscar?q=${encodeURIComponent(query)}`;

      // Update title
      document.title = newTitle;
      setMetaTag('meta[name="title"]', 'content', newTitle);

      // Update description
      setMetaTag('meta[name="description"]', 'content', newDescription);

      // Update canonical URL
      setMetaTag('link[rel="canonical"]', 'href', canonicalUrl);

      // Update Open Graph tags
      setMetaTag('meta[property="og:title"]', 'content', newTitle);
      setMetaTag('meta[property="og:description"]', 'content', newDescription);
      setMetaTag('meta[property="og:url"]', 'content', canonicalUrl);

      // Update Twitter tags
      setMetaTag('meta[name="twitter:title"]', 'content', newTitle);
      setMetaTag('meta[name="twitter:description"]', 'content', newDescription);
      setMetaTag('meta[name="twitter:url"]', 'content', canonicalUrl);

      // Remove noindex for valid queries (allow indexing)
      const robotsMeta = document.querySelector('meta[name="robots"]');
      if (robotsMeta) {
        robotsMeta.remove();
      }
    } else {
      // Reset to default for empty queries
      const defaultTitle = 'Buscar | OndaCoreana';
      const defaultDescription = 'Busca contenido sobre K-Dramas, K-Pop, noticias y guías de cultura coreana en español.';
      const canonicalUrl = `${siteUrl}/buscar`;

      document.title = defaultTitle;
      setMetaTag('meta[name="title"]', 'content', defaultTitle);
      setMetaTag('meta[name="description"]', 'content', defaultDescription);
      setMetaTag('link[rel="canonical"]', 'href', canonicalUrl);
      setMetaTag('meta[property="og:title"]', 'content', defaultTitle);
      setMetaTag('meta[property="og:description"]', 'content', defaultDescription);
      setMetaTag('meta[property="og:url"]', 'content', canonicalUrl);
      setMetaTag('meta[name="twitter:title"]', 'content', defaultTitle);
      setMetaTag('meta[name="twitter:description"]', 'content', defaultDescription);
      setMetaTag('meta[name="twitter:url"]', 'content', canonicalUrl);

      // Ensure noindex is present for empty queries
      let robotsMeta = document.querySelector('meta[name="robots"]');
      if (!robotsMeta) {
        robotsMeta = document.createElement('meta');
        robotsMeta.setAttribute('name', 'robots');
        robotsMeta.setAttribute('content', 'noindex, nofollow');
        document.head.appendChild(robotsMeta);
      }
    }
  }

  // Update filter tab active states
  function updateFilterActiveStates(activeType: ContentType) {
    const filterTabs = document.querySelectorAll('[data-testid="search-filters"] a');
    filterTabs.forEach((tab) => {
      const tabType = tab.getAttribute('data-filter-type') as ContentType;
      const isActive = tabType === activeType;
      tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      tab.setAttribute('data-active', isActive ? 'true' : 'false');
    });
  }

  // Initialize search on page load
  async function initSearch() {
    const container = document.getElementById('search-results-container');
    // Use the search input specifically on the buscar page (in main-content)
    const searchInput = document.querySelector('#main-content [data-testid="site-search-input"]') as HTMLInputElement;
    const truncationWarning = document.getElementById('truncation-warning');

    if (!container) return;

    // Get query and filter from URL
    const urlParams = new URLSearchParams(window.location.search);
    let query = urlParams.get('q')?.trim() || '';
    const filterType = (urlParams.get('type') as ContentType) || 'all';

    // Update filter tab active states
    updateFilterActiveStates(filterType);

    // Check for truncation
    const wasQueryTruncated = query.length > 100;
    if (wasQueryTruncated) {
      query = query.substring(0, 100);
      truncationWarning?.classList.remove('hidden');
    }

    // Update search input with query value
    if (searchInput && query) {
      searchInput.value = query;
    }

    // Validate query (FR-016: min 2 non-whitespace chars)
    const isValidQuery = query.length >= 2;

    if (!isValidQuery) {
      // Update SEO for empty/invalid query
      updateSEOMetaTags(query, 0);

      if (query.length > 0) {
        // Invalid query (too short)
        container.innerHTML = renderMinLengthWarning();
      } else {
        // Empty query - show welcome state
        container.innerHTML = renderEmptyState();
      }
      return;
    }

    // Show loading state
    container.innerHTML = renderLoadingState();

    try {
      // Load Pagefind dynamically at runtime (not bundled by Vite)
      const pagefind = await getPagefind();

      // Perform search with optional filter
      const searchOptions: PagefindSearchOptions = {};
      if (filterType !== 'all') {
        searchOptions.filters = {
          contentType: filterType
        };
      }
      const search = await pagefind.search(query, searchOptions);

      // Store search results for pagination
      currentSearchResults = search.results;
      currentQuery = query;
      displayedCount = 0;

      // Update SEO meta tags with result count
      updateSEOMetaTags(query, search.results.length);

      // Load and render initial results
      if (search.results.length > 0) {
        await loadMoreResults(container, query);
      } else {
        container.innerHTML = renderNoResults(query);
      }
    } catch (error) {
      console.error('Search error:', error);
      container.innerHTML = renderErrorState();
      // Update SEO even on error (with 0 results)
      updateSEOMetaTags(query, 0);
    }
  }

  // Render loading state
  function renderLoadingState(): string {
    return `
      <div id="search-loading" class="py-12 text-center">
        <svg class="mx-auto h-8 w-8 animate-spin" viewBox="0 0 24 24" style="color: var(--md-color-primary);">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
            fill="none"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
        <p style="margin-top: var(--md-spacing-sm); color: var(--md-color-on-surface-variant);">Buscando...</p>
      </div>
    `;
  }

  // Render empty state (no query)
  function renderEmptyState(): string {
    return `
      <div class="search-empty" style="text-align: center;">
        <svg class="mx-auto h-12 w-12" style="color: var(--md-color-on-surface-variant);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <h2 style="margin-top: var(--md-spacing-sm); font-size: var(--md-typo-title-medium-size); color: var(--md-color-on-surface);">
          ¿Qué quieres encontrar?
        </h2>
        <p style="margin-top: var(--md-spacing-xs); color: var(--md-color-on-surface-variant);">
          Usa el campo de búsqueda para encontrar K-Dramas, artistas de K-Pop, noticias y guías sobre cultura coreana.
        </p>
      </div>
    `;
  }

  // Render min length warning
  function renderMinLengthWarning(): string {
    return `
      <div class="search-empty">
        <p>Por favor ingresa al menos 2 caracteres para buscar.</p>
      </div>
    `;
  }

  // Render error state
  function renderErrorState(): string {
    return `
      <div class="search-empty" role="status">
        <h3>Error al cargar los resultados</h3>
        <p>Por favor intenta de nuevo más tarde.</p>
      </div>
    `;
  }

  // Render load more button
  function renderLoadMoreButton(): string {
    return `
      <button
        id="load-more-btn"
        class="btn btn--outline"
        style="width: 100%;"
        data-testid="load-more-btn"
      >
        Cargar más resultados
      </button>
    `;
  }

  // Render full search results section
  function renderSearchResults(results: SearchResult[], totalCount: number, query: string, hasMore: boolean = false): string {
    const resultMessage = totalCount === 1
      ? `1 resultado para "${escapeHtml(query)}"`
      : `${totalCount} resultados para "${escapeHtml(query)}"`;

    const loadMoreHtml = hasMore ? `
      <div id="load-more-container">
        ${renderLoadMoreButton()}
      </div>
    ` : '';

    return `
      <section class="search-results" data-testid="search-results">
        <p class="result-count" data-testid="result-count">
          ${resultMessage}
        </p>
        ${results.map(result => renderResultCard(result, query)).join('')}
        ${loadMoreHtml}
      </section>
    `;
  }

  // Render no results state
  function renderNoResults(query: string): string {
    return `
      <section class="search-results">
        <p class="result-count" data-testid="result-count">
          0 resultados para "${escapeHtml(query)}"
        </p>
        <div class="search-empty" data-testid="no-results">
          <h3>No se encontraron resultados</h3>
          <p>
            No encontramos artículos que coincidan con "${escapeHtml(query)}".
            Intenta con otros términos de búsqueda.
          </p>
          <div style="margin-top: var(--md-spacing-sm); text-align: left;">
            <p class="result-count">Sugerencias:</p>
            <ul style="margin-top: var(--md-spacing-xs); color: var(--md-color-on-surface-variant); padding-left: var(--md-spacing-lg); list-style: disc;">
              <li>Verifica la ortografía</li>
              <li>Usa palabras más generales</li>
              <li>Prueba con menos palabras clave</li>
            </ul>
          </div>
        </div>
      </section>
    `;
  }

  // Render a single result card
  function renderResultCard(result: SearchResult, query: string): string {
    const typeLabels: Record<string, string> = {
      dramas: 'K-Drama',
      kpop: 'K-Pop',
      noticias: 'Noticia',
      guias: 'Guía',
      all: 'Contenido',
    };

    const typeLabel = typeLabels[result.contentType] || result.contentType;

    const formattedDate = result.pubDate.toLocaleDateString('es-419', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    // Highlight query in excerpt
    const highlightedExcerpt = highlightMatch(result.excerpt, query);
    const highlightedTitle = highlightMatch(result.title, query);

    const heroImageHtml = result.heroImage ? `
      <div class="hidden sm:block search-result-card__media" aria-hidden="true">
        <img
          src="${escapeHtml(result.heroImage)}"
          alt=""
          loading="lazy"
          decoding="async"
        />
      </div>
    ` : '';

    return `
      <article class="search-result-card" data-testid="search-result-card">
        <a href="${escapeHtml(result.url)}" class="search-result-card__link">
          ${heroImageHtml}
          <div class="flex-1 min-w-0">
            <div class="flex flex-wrap items-center gap-2" style="margin-bottom: var(--md-spacing-xs);">
              <span
                class="search-result-chip"
                data-testid="result-type"
                data-variant="${result.contentType}"
              >
                ${typeLabel}
              </span>
            </div>
            <h3 class="search-result-title" data-testid="result-title">
              ${highlightedTitle}
            </h3>
            <p class="search-result-excerpt" data-testid="result-excerpt">
              ${highlightedExcerpt}
            </p>
            <time
              datetime="${result.pubDate.toISOString()}"
              class="search-result-date"
              data-testid="result-date"
            >
              ${formattedDate}
            </time>
          </div>
        </a>
      </article>
    `;
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }

  // Listen for filter changes (SPA-like navigation from SearchFilters)
  window.addEventListener('filterchange', () => {
    initSearch();
  });

  // Handle browser back/forward navigation
  window.addEventListener('popstate', () => {
    initSearch();
  });
</script>
