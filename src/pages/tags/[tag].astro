---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPublishedContent, type ContentCollection } from '../../utils/content-helpers';
import { contentTypeConfig } from '../../config/content-types';

export async function getStaticPaths() {
  // Get all content from all collections
  const collections: ContentCollection[] = ['dramas', 'kpop', 'noticias', 'guias'];
  const allEntries = await Promise.all(
    collections.map((c) => getPublishedContent(c))
  );

  // Combine all content with collection type
  const allContent = collections.flatMap((collectionType, index) =>
    allEntries[index].map(item => ({ ...item, collectionType }))
  );

  // Extract all unique tags
  const tagMap = new Map<string, typeof allContent>();

  allContent.forEach(item => {
    item.data.tags.forEach(tag => {
      const normalizedTag = tag.toLowerCase();
      if (!tagMap.has(normalizedTag)) {
        tagMap.set(normalizedTag, []);
      }
      tagMap.get(normalizedTag)!.push(item);
    });
  });

  // Generate paths for each tag
  return Array.from(tagMap.entries()).map(([tag, items]) => ({
    params: { tag },
    props: {
      items: items.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
      tagName: tag,
    },
  }));
}

interface Props {
  items: Array<{
    slug: string;
    data: {
      title: string;
      description: string;
      pubDate: Date;
      heroImage?: string;
      heroImageAlt?: string;
    };
    collectionType: 'dramas' | 'kpop' | 'noticias' | 'guias';
  }>;
  tagName: string;
}

const { items, tagName } = Astro.props;

// Capitalize tag for display
const displayTag = tagName.charAt(0).toUpperCase() + tagName.slice(1);
---

<BaseLayout
  title={`${displayTag} - Contenido etiquetado | OndaCoreana`}
  description={`Encuentra todo el contenido sobre ${displayTag} en OndaCoreana: K-Dramas, K-Pop, noticias y guías de cultura coreana.`}
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <header class="mb-8">
      <nav class="mb-4 text-sm text-[color:var(--oc-muted)]" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-[color:var(--oc-primary)]">Inicio</a></li>
          <li>/</li>
          <li><a href="/tags" class="hover:text-[color:var(--oc-primary)]">Tags</a></li>
          <li>/</li>
          <li class="text-[color:var(--oc-text)]">{displayTag}</li>
        </ol>
      </nav>
      <h1 class="text-3xl font-bold text-[color:var(--oc-text)] sm:text-4xl">
        #{displayTag}
      </h1>
      <p class="mt-2 text-[color:var(--oc-muted)]">
        {items.length} {items.length === 1 ? 'artículo encontrado' : 'artículos encontrados'}
      </p>
    </header>

    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {items.map((item) => {
        const config = contentTypeConfig[item.collectionType];
        const href = `/${item.collectionType}/${item.slug}`;

        return (
          <article class="group overflow-hidden rounded-lg border border-[color:var(--oc-border)] bg-[color:var(--oc-surface)] text-[color:var(--oc-text)] shadow-sm transition-shadow hover:shadow-md">
            {item.data.heroImage && (
              <img
                src={item.data.heroImage}
                alt={item.data.heroImageAlt || item.data.title}
                class="h-48 w-full object-cover"
                loading="lazy"
              />
            )}
            <div class="p-4">
              <span
                class="inline-block rounded-full px-3 py-1 text-xs font-medium"
                style={`background: ${config.bg}; color: ${config.color}; border: 1px solid var(--oc-border);`}
              >
                {config.label}
              </span>
              <h2 class="mt-2 text-lg font-semibold text-[color:var(--oc-text)] group-hover:text-[color:var(--oc-primary)]">
                <a href={href}>
                  {item.data.title}
                </a>
              </h2>
              <p class="mt-2 line-clamp-2 text-sm text-[color:var(--oc-muted)]">
                {item.data.description}
              </p>
              <time
                class="mt-3 block text-xs text-[color:var(--oc-muted-subtle)]"
                datetime={item.data.pubDate.toISOString()}
              >
                {item.data.pubDate.toLocaleDateString('es-419', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
            </div>
          </article>
        );
      })}
    </div>

    <div class="mt-12 border-t border-[color:var(--oc-border)] pt-8">
      <a href="/tags" class="font-medium text-[color:var(--oc-primary)] hover:text-[color:var(--oc-accent)]">
        ← Ver todas las etiquetas
      </a>
    </div>
  </div>
</BaseLayout>
