---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getMergedContent } from '../../utils/content-helpers';

// Get all content from all collections
const allContent = await getMergedContent(['dramas', 'kpop', 'noticias', 'guias']);

// Count tags
const tagCounts = new Map<string, number>();

allContent.forEach(item => {
  item.data.tags.forEach(tag => {
    const normalizedTag = tag.toLowerCase();
    tagCounts.set(normalizedTag, (tagCounts.get(normalizedTag) || 0) + 1);
  });
});

// Sort tags by count (descending) then alphabetically
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1];
    return a[0].localeCompare(b[0]);
  });
---

<BaseLayout
  title="Todas las Etiquetas | OndaCoreana"
  description="Explora todo el contenido de OndaCoreana por etiquetas: K-Dramas, K-Pop, noticias y guías de cultura coreana organizados por tema."
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <header class="mb-8">
      <nav class="mb-4 text-sm text-[color:var(--oc-muted)]" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-[color:var(--oc-primary)]">Inicio</a></li>
          <li>/</li>
          <li class="text-[color:var(--oc-text)]">Tags</li>
        </ol>
      </nav>
      <h1 class="text-3xl font-bold text-[color:var(--oc-text)] sm:text-4xl">
        Todas las Etiquetas
      </h1>
      <p class="mt-2 text-[color:var(--oc-muted)]">
        {sortedTags.length} {sortedTags.length === 1 ? 'etiqueta' : 'etiquetas'} en total
      </p>
    </header>

    {sortedTags.length > 0 ? (
      <div class="flex flex-wrap gap-3">
        {sortedTags.map(([tag, count]) => {
          const displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
          return (
            <a
              href={`/tags/${tag}`}
              class="group inline-flex items-center gap-2 rounded-full border border-[color:var(--oc-border)] bg-[color:var(--oc-surface)] px-4 py-2 text-sm font-medium text-[color:var(--oc-text)] transition-colors hover:border-[color:var(--oc-primary)] hover:bg-[color:var(--oc-primary-soft)] hover:text-[color:var(--oc-primary)]"
            >
              <span>#{displayTag}</span>
              <span
                class="rounded-full px-2 py-0.5 text-xs"
                style="background: var(--oc-surface-raised); color: var(--oc-muted); border: 1px solid var(--oc-border);"
              >
                {count}
              </span>
            </a>
          );
        })}
      </div>
    ) : (
      <p class="text-[color:var(--oc-muted)]">No hay etiquetas disponibles todavía.</p>
    )}

    <div class="mt-12 border-t border-[color:var(--oc-border)] pt-8">
      <a href="/" class="font-medium text-[color:var(--oc-primary)] hover:text-[color:var(--oc-accent)]">
        ← Volver al inicio
      </a>
    </div>
  </div>
</BaseLayout>
