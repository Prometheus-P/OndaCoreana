---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all content from all collections
const [allDramas, allKpop, allNoticias, allGuias] = await Promise.all([
  getCollection('dramas', ({ data }) => !data.draft),
  getCollection('kpop', ({ data }) => !data.draft),
  getCollection('noticias', ({ data }) => !data.draft),
  getCollection('guias', ({ data }) => !data.draft),
]);

// Combine all content
const allContent = [...allDramas, ...allKpop, ...allNoticias, ...allGuias];

// Count tags
const tagCounts = new Map<string, number>();

allContent.forEach(item => {
  item.data.tags.forEach(tag => {
    const normalizedTag = tag.toLowerCase();
    tagCounts.set(normalizedTag, (tagCounts.get(normalizedTag) || 0) + 1);
  });
});

// Sort tags by count (descending) then alphabetically
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1];
    return a[0].localeCompare(b[0]);
  });
---

<BaseLayout
  title="Todas las Etiquetas | OndaCoreana"
  description="Explora todo el contenido de OndaCoreana por etiquetas: K-Dramas, K-Pop, noticias y guías de cultura coreana organizados por tema."
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <header class="mb-8">
      <nav class="mb-4 text-sm text-gray-600" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-pink-600">Inicio</a></li>
          <li>/</li>
          <li class="text-gray-900">Tags</li>
        </ol>
      </nav>
      <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">
        Todas las Etiquetas
      </h1>
      <p class="mt-2 text-gray-600">
        {sortedTags.length} {sortedTags.length === 1 ? 'etiqueta' : 'etiquetas'} en total
      </p>
    </header>

    {sortedTags.length > 0 ? (
      <div class="flex flex-wrap gap-3">
        {sortedTags.map(([tag, count]) => {
          const displayTag = tag.charAt(0).toUpperCase() + tag.slice(1);
          return (
            <a
              href={`/tags/${tag}`}
              class="group inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:border-pink-300 hover:bg-pink-50 hover:text-pink-700 transition-colors"
            >
              <span>#{displayTag}</span>
              <span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600 group-hover:bg-pink-100 group-hover:text-pink-700">
                {count}
              </span>
            </a>
          );
        })}
      </div>
    ) : (
      <p class="text-gray-600">No hay etiquetas disponibles todavía.</p>
    )}

    <div class="mt-12 border-t border-gray-200 pt-8">
      <a href="/" class="text-pink-600 hover:text-pink-700 font-medium">
        ← Volver al inicio
      </a>
    </div>
  </div>
</BaseLayout>
