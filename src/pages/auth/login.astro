---
/**
 * Magic Link Login Page
 *
 * Server-rendered page for passwordless authentication.
 * Users enter their email and receive a Magic Link to sign in.
 */
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';

// Get redirect URL from query params (for post-login redirect)
const nextUrl = Astro.url.searchParams.get('next') || '/dashboard';
const error = Astro.url.searchParams.get('error');

// Handle form submission
let formState: 'idle' | 'success' | 'error' = 'idle';
let formError = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const email = formData.get('email')?.toString().trim();

    if (!email) {
      formState = 'error';
      formError = 'Por favor, ingresa tu correo electrónico.';
    } else if (!email.includes('@')) {
      formState = 'error';
      formError = 'Por favor, ingresa un correo electrónico válido.';
    } else {
      // Request Magic Link
      const { error: signInError } = await Astro.locals.supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: new URL('/auth/callback', Astro.url.origin).toString(),
        },
      });

      if (signInError) {
        formState = 'error';
        // Handle rate limiting
        if (signInError.message.includes('rate limit') || signInError.status === 429) {
          formError = 'Has solicitado demasiados enlaces. Por favor, espera unos minutos antes de intentar de nuevo.';
        } else {
          formError = 'No pudimos enviar el enlace. Por favor, intenta de nuevo.';
        }
      } else {
        formState = 'success';
      }
    }
  } catch (e) {
    formState = 'error';
    formError = 'Ocurrió un error inesperado. Por favor, intenta de nuevo.';
  }
}

// Map error codes to Spanish messages
const errorMessages: Record<string, string> = {
  callback_failed: 'El enlace de inicio de sesión ha expirado o es inválido. Por favor, solicita uno nuevo.',
  session_expired: 'Tu sesión ha expirado. Por favor, inicia sesión de nuevo.',
};

const displayError = error ? errorMessages[error] || 'Ocurrió un error. Por favor, intenta de nuevo.' : formError;
---

<BaseLayout
  title="Iniciar Sesión | OndaCoreana"
  description="Inicia sesión en OndaCoreana con tu correo electrónico"
  noindex={true}
  showSearch={false}
>
  <div class="flex min-h-[calc(100vh-200px)] items-center justify-center px-4 py-12">
    <div
      class="w-full max-w-md rounded-2xl p-8"
      style="background-color: var(--md-color-surface-container); box-shadow: var(--md-elevation-2);"
    >
      <!-- Header -->
      <div class="mb-8 text-center">
        <h1
          class="text-2xl font-bold"
          style="color: var(--md-color-on-surface);"
        >
          Iniciar Sesión
        </h1>
        <p
          class="mt-2 text-sm"
          style="color: var(--md-color-on-surface-variant);"
        >
          Ingresa tu correo y te enviaremos un enlace mágico
        </p>
      </div>

      {formState === 'success' ? (
        <!-- Success State -->
        <div
          class="rounded-xl p-6 text-center"
          style="background-color: color-mix(in srgb, var(--md-color-primary) 10%, transparent);"
        >
          <div
            class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full"
            style="background-color: var(--md-color-primary);"
          >
            <svg
              class="h-8 w-8"
              style="color: var(--md-color-on-primary);"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <h2
            class="text-lg font-semibold"
            style="color: var(--md-color-on-surface);"
          >
            ¡Revisa tu correo!
          </h2>
          <p
            class="mt-2 text-sm"
            style="color: var(--md-color-on-surface-variant);"
          >
            Te hemos enviado un enlace mágico para iniciar sesión.
            El enlace expira en 1 hora.
          </p>
          <a
            href="/auth/login"
            class="mt-6 inline-block text-sm font-medium"
            style="color: var(--md-color-primary);"
          >
            ¿No recibiste el correo? Solicitar otro
          </a>
        </div>
      ) : (
        <!-- Login Form -->
        <form method="POST" class="space-y-6">
          <input type="hidden" name="next" value={nextUrl} />

          {displayError && (
            <div
              class="rounded-lg p-4 text-sm"
              style="background-color: color-mix(in srgb, var(--md-color-error) 10%, transparent); color: var(--md-color-error);"
              role="alert"
            >
              {displayError}
            </div>
          )}

          <div>
            <label
              for="email"
              class="block text-sm font-medium"
              style="color: var(--md-color-on-surface);"
            >
              Correo electrónico
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              placeholder="tu@correo.com"
              class="mt-2 block w-full rounded-lg border px-4 py-3 text-base transition-colors focus:outline-none focus:ring-2"
              style="
                background-color: var(--md-color-surface);
                border-color: var(--md-color-outline);
                color: var(--md-color-on-surface);
              "
            />
          </div>

          <button
            type="submit"
            class="w-full rounded-full px-6 py-3 text-base font-medium transition-all hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2"
            style="
              background-color: var(--md-color-primary);
              color: var(--md-color-on-primary);
              min-height: 44px;
            "
          >
            Enviar enlace mágico
          </button>

          <p
            class="text-center text-xs"
            style="color: var(--md-color-on-surface-variant);"
          >
            Solo puedes solicitar un enlace cada 5 minutos
          </p>
        </form>
      )}

      <!-- Back to home -->
      <div class="mt-8 text-center">
        <a
          href="/"
          class="text-sm"
          style="color: var(--md-color-on-surface-variant);"
        >
          ← Volver al inicio
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  input:focus {
    border-color: var(--md-color-primary);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--md-color-primary) 20%, transparent);
  }

  input::placeholder {
    color: var(--md-color-on-surface-variant);
    opacity: 0.7;
  }
</style>

<script>
  /**
   * Client-side rate limiting for Magic Link requests.
   * Prevents users from spamming the form.
   */
  const THROTTLE_MS = 5 * 60 * 1000; // 5 minutes
  const STORAGE_KEY = 'magic_link_last_request';

  const form = document.querySelector('form');
  const submitButton = form?.querySelector('button[type="submit"]');

  function getLastRequestTime(): number {
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? parseInt(stored, 10) : 0;
  }

  function canMakeRequest(): boolean {
    const lastRequest = getLastRequestTime();
    return Date.now() - lastRequest >= THROTTLE_MS;
  }

  function getRemainingTime(): number {
    const lastRequest = getLastRequestTime();
    const elapsed = Date.now() - lastRequest;
    return Math.max(0, THROTTLE_MS - elapsed);
  }

  function formatTime(ms: number): string {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  function updateButtonState() {
    if (!submitButton || !(submitButton instanceof HTMLButtonElement)) return;

    if (!canMakeRequest()) {
      const remaining = getRemainingTime();
      submitButton.disabled = true;
      submitButton.textContent = `Espera ${formatTime(remaining)}`;
      submitButton.style.opacity = '0.6';
      submitButton.style.cursor = 'not-allowed';

      // Update every second
      setTimeout(updateButtonState, 1000);
    } else {
      submitButton.disabled = false;
      submitButton.textContent = 'Enviar enlace mágico';
      submitButton.style.opacity = '1';
      submitButton.style.cursor = 'pointer';
    }
  }

  form?.addEventListener('submit', (e) => {
    if (!canMakeRequest()) {
      e.preventDefault();
      return;
    }
    localStorage.setItem(STORAGE_KEY, Date.now().toString());
  });

  // Initialize button state on page load
  updateButtonState();
</script>
