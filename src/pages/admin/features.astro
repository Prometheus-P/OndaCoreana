---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminGate from '../../components/admin/AdminGate.astro';
import FeatureForm from '../../components/admin/FeatureForm.astro';
import FeaturePreview from '../../components/admin/FeaturePreview.astro';
---

<AdminLayout title="Admin | Features" breadcrumbs={['Admin', 'Features']}>
  <AdminGate redirect="/admin/features">
    <div class="split">
      <FeatureForm />
      <FeaturePreview />
    </div>
    <div class="help card">
      <h4>Guía rápida para audiencia LatAm</h4>
      <ul>
        <li>Escribe en español y resalta contexto local (ciudades, comida, festivales).</li>
        <li>Añade al menos un gancho LatAm (tour stops, slang, fútbol, gastronomía).</li>
        <li>Incluye CTA localizado: "Descubre más en Latinoamérica".</li>
      </ul>
    </div>
  </AdminGate>
</AdminLayout>

<style>
  .split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  .help {
    margin-top: 12px;
  }
  .card {
    background: #121a30;
    border: 1px solid #1f2a44;
    border-radius: 12px;
    padding: 16px;
  }
  ul {
    color: #c7d0e5;
  }
  @media (max-width: 1024px) {
    .split {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const form = document.getElementById('feature-form');
  const preview = {
    title: document.querySelector('[data-preview="title"]'),
    description: document.querySelector('[data-preview="description"]'),
    category: document.querySelector('[data-preview="category"]'),
    latamHook: document.querySelector('[data-preview="latamHook"]'),
    countries: document.querySelector('[data-preview="countries"]'),
    tags: document.querySelector('[data-preview="tags"]'),
    publishDate: document.querySelector('[data-preview="publishDate"]'),
    blocks: document.querySelector('[data-preview="blocks"]'),
    heroImage: document.querySelector('[data-preview="heroImage"]'),
  };

  const getField = <T extends HTMLElement = HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>(id: string) => (form?.querySelector(`#${id}`) as T | null);

  const parseList = (value: string) =>
    value
      .split(',')
      .map((v) => v.trim())
      .filter(Boolean);

  const hydratePreview = () => {
    if (!form) return;
    const title = getField('title')?.value || 'Título de la nota';
    const description = getField('descriptionEs')?.value || 'Descripción en español para la audiencia latina.';
    const category = (getField<HTMLSelectElement>('category'))?.value || 'Categoría';
    const countries = parseList(getField('countries')?.value || 'MX, CL').join(', ');
    const hooks = parseList(getField('latamHook')?.value || 'Engagement, Cultura');
    const tags = parseList(getField('tags')?.value || 'kpop, eventos').join(', ');
    const publishDate = getField('publishDate')?.value || '2024-12-03';
    const blocksValue = (getField('blocks') as HTMLTextAreaElement | null)?.value || '';

    if (preview.title) preview.title.textContent = title;
    if (preview.description) preview.description.textContent = description;
    if (preview.category) preview.category.textContent = category;
    if (preview.latamHook) preview.latamHook.textContent = hooks.join(' · ');
    if (preview.countries) preview.countries.textContent = countries;
    if (preview.tags) preview.tags.textContent = tags;
    if (preview.publishDate) preview.publishDate.textContent = publishDate;

    if (preview.blocks) {
      preview.blocks.innerHTML = '';
      if (!blocksValue.trim()) {
        preview.blocks.innerHTML = '<p>Agrega bloques para verlos aquí.</p>';
      } else {
        blocksValue.split('\n').forEach((line) => {
          const [heading, body] = line.split('::');
          const block = document.createElement('div');
          if (heading) {
            const h = document.createElement('h5');
            h.textContent = heading.trim();
            block.appendChild(h);
          }
          const p = document.createElement('p');
          p.textContent = (body || heading || '').trim();
          block.appendChild(p);
          preview.blocks?.appendChild(block);
        });
      }
    }
  };

  // Validation helper
  interface ValidationError {
    field: string;
    message: string;
  }

  const validateForm = (): ValidationError[] => {
    const errors: ValidationError[] = [];

    const title = getField('title')?.value?.trim();
    if (!title) {
      errors.push({ field: 'title', message: 'El título es obligatorio' });
    }

    const descriptionEs = getField('descriptionEs')?.value?.trim();
    if (!descriptionEs) {
      errors.push({ field: 'descriptionEs', message: 'La descripción es obligatoria' });
    }

    const category = (getField<HTMLSelectElement>('category'))?.value;
    if (!category) {
      errors.push({ field: 'category', message: 'Selecciona una categoría' });
    }

    const countries = parseList(getField('countries')?.value || '');
    if (!countries.length) {
      errors.push({ field: 'countries', message: 'Añade al menos un país' });
    }

    const latamHook = parseList(getField('latamHook')?.value || '');
    if (!latamHook.length) {
      errors.push({ field: 'latamHook', message: 'Añade al menos un gancho LatAm' });
    }

    const publishDate = getField('publishDate')?.value;
    if (!publishDate) {
      errors.push({ field: 'publishDate', message: 'La fecha de publicación es obligatoria' });
    }

    const heroImage = getField('heroImage')?.value?.trim();
    if (!heroImage) {
      errors.push({ field: 'heroImage', message: 'La imagen hero es obligatoria' });
    }

    const heroImageAlt = getField('heroImageAlt')?.value?.trim();
    if (!heroImageAlt) {
      errors.push({ field: 'heroImageAlt', message: 'El texto alt de la imagen es obligatorio' });
    }

    return errors;
  };

  // Slug generation helper
  const generateSlug = (title: string): string => {
    return title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
      .replace(/[^a-z0-9\s-]/g, '') // Remove special chars
      .trim()
      .replace(/\s+/g, '-') // Replace spaces with hyphens
      .replace(/-+/g, '-'); // Remove consecutive hyphens
  };

  // Known existing slugs (loaded at build time, this is a simplified check)
  // In production, this would ideally check against the actual content directory
  const existingSlugs = new Set(['latam-demo']); // Add known slugs here

  const isSlugUnique = (slug: string): boolean => {
    return !existingSlugs.has(slug);
  };

  const showValidationErrors = (errors: ValidationError[]) => {
    // Clear previous errors
    form?.querySelectorAll('.field-error').forEach((el) => el.remove());
    form?.querySelectorAll('.error-border').forEach((el) => el.classList.remove('error-border'));

    errors.forEach((err) => {
      const field = getField(err.field);
      if (field) {
        field.classList.add('error-border');
        const errorEl = document.createElement('span');
        errorEl.className = 'field-error';
        errorEl.textContent = err.message;
        errorEl.style.cssText = 'color: #ff7787; font-size: 12px; display: block; margin-top: 4px;';
        field.parentElement?.appendChild(errorEl);
      }
    });

    // Alert summary
    const messages = errors.map((e) => `• ${e.message}`).join('\n');
    alert(`Corrige los siguientes errores antes de exportar:\n\n${messages}`);
  };

  const exportMdx = () => {
    if (!form) return;

    // Validate all required fields
    const errors = validateForm();
    if (errors.length > 0) {
      showValidationErrors(errors);
      return;
    }

    const title = getField('title')?.value || 'Nueva nota';
    const slug = generateSlug(title);

    // Check for duplicate slug
    if (!isSlugUnique(slug)) {
      alert(`El slug "${slug}" ya existe. Por favor cambia el título para generar un slug único.`);
      return;
    }

    const payload = {
      title,
      descriptionEs: getField('descriptionEs')?.value || '',
      category: (getField<HTMLSelectElement>('category'))?.value || 'culture',
      countries: parseList(getField('countries')?.value || ''),
      latamHook: parseList(getField('latamHook')?.value || ''),
      heroImage: getField('heroImage')?.value || '',
      heroImageAlt: getField('heroImageAlt')?.value || '',
      publishDate: getField('publishDate')?.value || new Date().toISOString().slice(0, 10),
      author: getField('author')?.value || 'OndaCoreana',
      tags: parseList(getField('tags')?.value || ''),
      blocks:
        (getField('blocks') as HTMLTextAreaElement | null)?.value
          .split('\n')
          .filter(Boolean)
          .map((line) => {
            const [heading, body] = line.split('::');
            return { heading: heading?.trim(), body: (body || heading || '').trim() };
          }) || [],
      seoMeta: {
        title: (getField('seoTitle') as HTMLInputElement | null)?.value || undefined,
        description: (getField('seoDescription') as HTMLInputElement | null)?.value || undefined,
      },
    };

    const frontmatter = `---\n${Object.entries(payload)
      .map(([key, val]) => `${key}: ${JSON.stringify(val, null, 2).replace(/\"([^(\")"]+)\":/g, '$1:')}`)
      .join('\n')}\n---\n\n`;
    const body =
      payload.blocks
        ?.map((b) => {
          const heading = b.heading ? `## ${b.heading}\n` : '';
          return `${heading}${b.body}`;
        })
        .join('\n\n') || '';

    const blob = new Blob([frontmatter + body], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${slug}.mdx`;
    a.click();
    URL.revokeObjectURL(url);

    // Add slug to known slugs to prevent immediate duplicate
    existingSlugs.add(slug);
  };

  const handleAi = () => {
    alert('AI agent: conecta AI_AGENT_ENDPOINT para generar sugerencias.');
  };

  form?.addEventListener('input', hydratePreview);
  document.getElementById('export-mdx')?.addEventListener('click', exportMdx);
  document.getElementById('ai-generate')?.addEventListener('click', handleAi);
  hydratePreview();
</script>
