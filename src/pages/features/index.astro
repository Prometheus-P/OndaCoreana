---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all non-draft features
const allFeatures = await getCollection('features', ({ data }) => !data.draft);

// Sort by publish date (newest first)
const features = allFeatures.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

// Extract unique categories and countries for filters
const categories = [...new Set(features.map((f) => f.data.category))];
const countries = [...new Set(features.flatMap((f) => f.data.countries))].sort();

// Category config
const categoryConfig: Record<string, { label: string; bg: string; text: string }> = {
  music: { label: 'Música', bg: 'var(--oc-accent-soft)', text: 'var(--oc-text)' },
  series: { label: 'Series', bg: 'var(--oc-primary-soft)', text: 'var(--oc-text)' },
  event: { label: 'Evento', bg: 'color-mix(in srgb, var(--oc-accent) 12%, var(--oc-surface))', text: 'var(--oc-text)' },
  gastronomy: { label: 'Gastronomía', bg: 'color-mix(in srgb, var(--oc-primary) 10%, var(--oc-surface))', text: 'var(--oc-text)' },
  culture: { label: 'Cultura', bg: 'var(--oc-accent-soft)', text: 'var(--oc-text)' },
};
---

<BaseLayout
  title="Features - Contenido especial para LatAm | OndaCoreana"
  description="Descubre contenido especial sobre K-Culture para la comunidad latina: eventos, guías, música y más."
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Header -->
    <header class="mb-8">
      <nav class="mb-4 text-sm text-[color:var(--oc-muted)]" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-[color:var(--oc-primary)]">Inicio</a></li>
          <li>/</li>
          <li class="text-[color:var(--oc-text)]">Features</li>
        </ol>
      </nav>
      <h1 class="text-3xl font-bold text-[color:var(--oc-text)] sm:text-4xl">Features</h1>
      <p class="mt-2 text-lg text-[color:var(--oc-muted)]">
        Contenido especial sobre K-Culture para la comunidad latina
      </p>
    </header>

    <!-- Filters -->
    <div class="mb-8 flex flex-wrap gap-4" id="filters">
      <!-- Category Filter -->
      <div>
        <label for="category-filter" class="mb-1 block text-sm font-medium text-[color:var(--oc-text)]">
          Categoría
        </label>
        <select
          id="category-filter"
          class="rounded-lg border border-[color:var(--oc-border)] bg-[color:var(--oc-surface)] px-4 py-2 text-sm text-[color:var(--oc-text)] transition-colors focus:border-[color:var(--oc-primary)] focus:outline-none focus:ring-2 focus:ring-[color:var(--oc-primary)]"
        >
          <option value="">Todas</option>
          {categories.map((cat) => (
            <option value={cat}>{categoryConfig[cat]?.label || cat}</option>
          ))}
        </select>
      </div>

      <!-- Country Filter -->
      <div>
        <label for="country-filter" class="mb-1 block text-sm font-medium text-[color:var(--oc-text)]">
          País
        </label>
        <select
          id="country-filter"
          class="rounded-lg border border-[color:var(--oc-border)] bg-[color:var(--oc-surface)] px-4 py-2 text-sm text-[color:var(--oc-text)] transition-colors focus:border-[color:var(--oc-primary)] focus:outline-none focus:ring-2 focus:ring-[color:var(--oc-primary)]"
        >
          <option value="">Todos</option>
          {countries.map((country) => (
            <option value={country}>{country}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Features Grid -->
    {features.length > 0 ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3" id="features-grid">
        {features.map((feature) => {
          const catInfo = categoryConfig[feature.data.category] || categoryConfig.culture;
          return (
            <article
              class="feature-card group overflow-hidden rounded-lg border border-[color:var(--oc-border)] bg-[color:var(--oc-surface)] text-[color:var(--oc-text)] shadow-sm transition-shadow hover:shadow-md"
              data-category={feature.data.category}
              data-countries={feature.data.countries.join(',')}
            >
              {feature.data.heroImage && (
                <img
                  src={feature.data.heroImage}
                  alt={feature.data.heroImageAlt || feature.data.title}
                  class="h-48 w-full object-cover"
                  loading="lazy"
                />
              )}
              <div class="p-4">
                <div class="mb-2 flex flex-wrap items-center gap-2">
                  <span
                    class="inline-block rounded-full px-2.5 py-0.5 text-xs font-medium"
                    style={`background: ${catInfo.bg}; color: ${catInfo.text}; border: 1px solid var(--oc-border);`}
                  >
                    {catInfo.label}
                  </span>
                  {feature.data.countries.slice(0, 2).map((country) => (
                    <span
                      class="inline-block rounded-full px-2 py-0.5 text-xs"
                      style="background: var(--oc-surface-raised); color: var(--oc-muted); border: 1px solid var(--oc-border);"
                    >
                      {country}
                    </span>
                  ))}
                </div>
                <h2 class="line-clamp-2 text-lg font-semibold text-[color:var(--oc-text)] group-hover:text-[color:var(--oc-primary)]">
                  <a href={`/features/${feature.slug}`}>
                    {feature.data.title}
                  </a>
                </h2>
                <p class="mt-2 line-clamp-2 text-sm text-[color:var(--oc-muted)]">
                  {feature.data.descriptionEs}
                </p>
                <time
                  class="mt-3 block text-xs text-[color:var(--oc-muted-subtle)]"
                  datetime={feature.data.publishDate.toISOString()}
                >
                  {feature.data.publishDate.toLocaleDateString('es-419', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <p class="py-12 text-center text-[color:var(--oc-muted)]">
        No hay features disponibles todavía.
      </p>
    )}

    <!-- No results message (hidden by default) -->
    <p id="no-results" class="hidden py-12 text-center text-[color:var(--oc-muted)]">
      No se encontraron features con los filtros seleccionados.
    </p>

    <div class="mt-12 border-t border-[color:var(--oc-border)] pt-8">
      <a href="/" class="font-medium text-[color:var(--oc-primary)] hover:text-[color:var(--oc-accent)]">
        ← Volver al inicio
      </a>
    </div>
  </div>
</BaseLayout>

<script>
  const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
  const countryFilter = document.getElementById('country-filter') as HTMLSelectElement;
  const grid = document.getElementById('features-grid');
  const noResults = document.getElementById('no-results');
  const cards = document.querySelectorAll('.feature-card');

  function filterFeatures() {
    const selectedCategory = categoryFilter?.value || '';
    const selectedCountry = countryFilter?.value || '';

    let visibleCount = 0;

    cards.forEach((card) => {
      const cardCategory = card.getAttribute('data-category') || '';
      const cardCountries = card.getAttribute('data-countries') || '';

      const matchesCategory = !selectedCategory || cardCategory === selectedCategory;
      const matchesCountry = !selectedCountry || cardCountries.includes(selectedCountry);

      if (matchesCategory && matchesCountry) {
        (card as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    // Show/hide no results message
    if (noResults && grid) {
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
        grid.classList.add('hidden');
      } else {
        noResults.classList.add('hidden');
        grid.classList.remove('hidden');
      }
    }
  }

  categoryFilter?.addEventListener('change', filterFeatures);
  countryFilter?.addEventListener('change', filterFeatures);
</script>
