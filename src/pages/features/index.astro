---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all non-draft features
const allFeatures = await getCollection('features', ({ data }) => !data.draft);

// Sort by publish date (newest first)
const features = allFeatures.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

// Extract unique categories and countries for filters
const categories = [...new Set(features.map((f) => f.data.category))];
const countries = [...new Set(features.flatMap((f) => f.data.countries))].sort();

// Category config
const categoryConfig: Record<string, { label: string; color: string }> = {
  music: { label: 'Música', color: 'bg-purple-100 text-purple-800' },
  series: { label: 'Series', color: 'bg-pink-100 text-pink-800' },
  event: { label: 'Evento', color: 'bg-blue-100 text-blue-800' },
  gastronomy: { label: 'Gastronomía', color: 'bg-orange-100 text-orange-800' },
  culture: { label: 'Cultura', color: 'bg-teal-100 text-teal-800' },
};
---

<BaseLayout
  title="Features - Contenido especial para LatAm | OndaCoreana"
  description="Descubre contenido especial sobre K-Culture para la comunidad latina: eventos, guías, música y más."
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Header -->
    <header class="mb-8">
      <nav class="mb-4 text-sm text-gray-600" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="hover:text-pink-600">Inicio</a></li>
          <li>/</li>
          <li class="text-gray-900">Features</li>
        </ol>
      </nav>
      <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">Features</h1>
      <p class="mt-2 text-lg text-gray-600">
        Contenido especial sobre K-Culture para la comunidad latina
      </p>
    </header>

    <!-- Filters -->
    <div class="mb-8 flex flex-wrap gap-4" id="filters">
      <!-- Category Filter -->
      <div>
        <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-1">
          Categoría
        </label>
        <select
          id="category-filter"
          class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm focus:border-pink-500 focus:ring-pink-500"
        >
          <option value="">Todas</option>
          {categories.map((cat) => (
            <option value={cat}>{categoryConfig[cat]?.label || cat}</option>
          ))}
        </select>
      </div>

      <!-- Country Filter -->
      <div>
        <label for="country-filter" class="block text-sm font-medium text-gray-700 mb-1">
          País
        </label>
        <select
          id="country-filter"
          class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm focus:border-pink-500 focus:ring-pink-500"
        >
          <option value="">Todos</option>
          {countries.map((country) => (
            <option value={country}>{country}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Features Grid -->
    {features.length > 0 ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3" id="features-grid">
        {features.map((feature) => {
          const catInfo = categoryConfig[feature.data.category] || categoryConfig.culture;
          return (
            <article
              class="feature-card group rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow-md transition-shadow overflow-hidden"
              data-category={feature.data.category}
              data-countries={feature.data.countries.join(',')}
            >
              {feature.data.heroImage && (
                <img
                  src={feature.data.heroImage}
                  alt={feature.data.heroImageAlt || feature.data.title}
                  class="h-48 w-full object-cover"
                  loading="lazy"
                />
              )}
              <div class="p-4">
                <div class="flex flex-wrap items-center gap-2 mb-2">
                  <span class={`inline-block rounded-full px-2.5 py-0.5 text-xs font-medium ${catInfo.color}`}>
                    {catInfo.label}
                  </span>
                  {feature.data.countries.slice(0, 2).map((country) => (
                    <span class="inline-block rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">
                      {country}
                    </span>
                  ))}
                </div>
                <h2 class="text-lg font-semibold text-gray-900 group-hover:text-pink-600 line-clamp-2">
                  <a href={`/features/${feature.slug}`}>
                    {feature.data.title}
                  </a>
                </h2>
                <p class="mt-2 text-sm text-gray-600 line-clamp-2">
                  {feature.data.descriptionEs}
                </p>
                <time
                  class="mt-3 block text-xs text-gray-500"
                  datetime={feature.data.publishDate.toISOString()}
                >
                  {feature.data.publishDate.toLocaleDateString('es-419', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <p class="text-center text-gray-600 py-12">
        No hay features disponibles todavía.
      </p>
    )}

    <!-- No results message (hidden by default) -->
    <p id="no-results" class="hidden text-center text-gray-600 py-12">
      No se encontraron features con los filtros seleccionados.
    </p>

    <div class="mt-12 border-t border-gray-200 pt-8">
      <a href="/" class="text-pink-600 hover:text-pink-700 font-medium">
        ← Volver al inicio
      </a>
    </div>
  </div>
</BaseLayout>

<script>
  const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
  const countryFilter = document.getElementById('country-filter') as HTMLSelectElement;
  const grid = document.getElementById('features-grid');
  const noResults = document.getElementById('no-results');
  const cards = document.querySelectorAll('.feature-card');

  function filterFeatures() {
    const selectedCategory = categoryFilter?.value || '';
    const selectedCountry = countryFilter?.value || '';

    let visibleCount = 0;

    cards.forEach((card) => {
      const cardCategory = card.getAttribute('data-category') || '';
      const cardCountries = card.getAttribute('data-countries') || '';

      const matchesCategory = !selectedCategory || cardCategory === selectedCategory;
      const matchesCountry = !selectedCountry || cardCountries.includes(selectedCountry);

      if (matchesCategory && matchesCountry) {
        (card as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    // Show/hide no results message
    if (noResults && grid) {
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
        grid.classList.add('hidden');
      } else {
        noResults.classList.add('hidden');
        grid.classList.remove('hidden');
      }
    }
  }

  categoryFilter?.addEventListener('change', filterFeatures);
  countryFilter?.addEventListener('change', filterFeatures);
</script>
