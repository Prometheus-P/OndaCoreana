---
import BaseLayout from '../../layouts/BaseLayout.astro';
import JsonLd from '../../components/seo/JsonLd.astro';
import ShareButtons from '../../components/ui/ShareButtons.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const features = await getCollection('features', ({ data }) => !data.draft);
  return features.map((feature) => ({
    params: { slug: feature.slug },
    props: { feature },
  }));
}

const { feature } = Astro.props;
const { Content } = await feature.render();

const {
  title,
  descriptionEs,
  category,
  countries,
  latamHook,
  heroImage,
  heroImageAlt,
  publishDate,
  author,
  tags,
  seoMeta,
} = feature.data;

// SEO meta with fallbacks
const seoTitle = seoMeta?.title || title;
const seoDescription = seoMeta?.description || descriptionEs;
const ogImage = seoMeta?.ogImage || heroImage;

const formattedDate = publishDate.toLocaleDateString('es-419', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Category labels and colors
const categoryConfig: Record<string, { label: string; bg: string; text: string }> = {
  music: { label: 'Música', bg: 'var(--oc-accent-soft)', text: 'var(--oc-text)' },
  series: { label: 'Series', bg: 'var(--oc-primary-soft)', text: 'var(--oc-text)' },
  event: { label: 'Evento', bg: 'color-mix(in srgb, var(--oc-accent) 12%, var(--oc-surface))', text: 'var(--oc-text)' },
  gastronomy: { label: 'Gastronomía', bg: 'color-mix(in srgb, var(--oc-primary) 10%, var(--oc-surface))', text: 'var(--oc-text)' },
  culture: { label: 'Cultura', bg: 'var(--oc-accent-soft)', text: 'var(--oc-text)' },
};

const categoryInfo = categoryConfig[category] || categoryConfig.culture;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  image={ogImage}
  imageAlt={heroImageAlt || title}
  type="article"
  publishedTime={publishDate}
  author={author}
>
  <Fragment slot="head">
    <JsonLd
      schema={[
        {
          type: 'Article',
          headline: title,
          description: descriptionEs,
          image: heroImage,
          datePublished: publishDate,
          author,
        },
        {
          type: 'BreadcrumbList',
          items: [
            { name: 'Inicio', url: '/' },
            { name: 'Features', url: '/features' },
            { name: title, url: Astro.url.pathname },
          ],
        },
      ]}
    />

    <meta data-pagefind-meta="title" content={title} />
    <meta data-pagefind-meta="description" content={descriptionEs} />
    <meta data-pagefind-meta="contentType" data-pagefind-filter="contentType" content="features" />
    <meta data-pagefind-meta="pubDate" content={publishDate.toISOString()} />
    {heroImage && <meta data-pagefind-meta="heroImage" content={heroImage} />}
    {tags.length > 0 && <meta data-pagefind-meta="tags" content={tags.join(', ')} />}
  </Fragment>

  <article class="mx-auto max-w-4xl px-4 py-12 sm:px-6 lg:px-8" data-pagefind-body>
    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" class="mb-6">
      <ol class="flex flex-wrap items-center gap-2 text-sm text-[color:var(--oc-muted)]">
        <li><a href="/" class="hover:text-[color:var(--oc-primary)]">Inicio</a></li>
        <li>/</li>
        <li><a href="/features" class="hover:text-[color:var(--oc-primary)]">Features</a></li>
        <li>/</li>
        <li class="text-[color:var(--oc-muted-subtle)]" aria-current="page">{title}</li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="mb-4 flex flex-wrap items-center gap-2">
        <span
          class="inline-block rounded-full px-3 py-1 text-xs font-medium"
          style={`background: ${categoryInfo.bg}; color: ${categoryInfo.text}; border: 1px solid var(--oc-border);`}
        >
          {categoryInfo.label}
        </span>
        {countries.map((country) => (
          <span
            class="inline-block rounded-full px-3 py-1 text-xs font-medium"
            style="background: var(--oc-surface-raised); color: var(--oc-muted); border: 1px solid var(--oc-border);"
          >
            {country}
          </span>
        ))}
      </div>

      <h1 class="text-3xl font-bold text-[color:var(--oc-text)] sm:text-4xl lg:text-5xl" data-pagefind-meta="title">
        {title}
      </h1>

      <p class="mt-4 text-lg text-[color:var(--oc-muted)]">{descriptionEs}</p>

      <div class="mt-4 flex flex-wrap items-center gap-4 text-sm text-[color:var(--oc-muted)]">
        <span>Por {author}</span>
        <span>•</span>
        <time datetime={publishDate.toISOString()}>{formattedDate}</time>
      </div>

      <!-- Share Buttons -->
      <div class="mt-4">
        <ShareButtons
          title={title}
          url={`https://ondacoreana.com${Astro.url.pathname}`}
          description={descriptionEs}
        />
      </div>

      <!-- LatAm Hooks -->
      {latamHook.length > 0 && (
        <div
          class="mt-6 rounded-lg p-4"
          style="background: linear-gradient(90deg, var(--oc-primary-soft), var(--oc-accent-soft)); border: 1px solid var(--oc-border);"
        >
          <h2 class="mb-2 text-sm font-semibold text-[color:var(--oc-text)]">Destacado para LatAm:</h2>
          <div class="flex flex-wrap gap-2">
            {latamHook.map((hook) => (
              <span
                class="inline-block rounded-full px-3 py-1 text-sm"
                style="background: var(--oc-surface); color: var(--oc-primary); border: 1px solid var(--oc-border);"
              >
                {hook}
              </span>
            ))}
          </div>
        </div>
      )}
    </header>

    <!-- Hero Image -->
    {heroImage && (
      <figure class="mb-8">
        <img
          src={heroImage}
          alt={heroImageAlt || title}
          class="w-full rounded-xl object-cover shadow-lg"
          loading="eager"
        />
      </figure>
    )}

    <!-- MDX Content -->
    <div class="prose prose-lg prose-pink mx-auto max-w-none text-[color:var(--oc-text)] prose-headings:text-[color:var(--oc-text)] prose-p:text-[color:var(--oc-muted)] prose-strong:text-[color:var(--oc-text)] prose-a:text-[color:var(--oc-primary)] hover:prose-a:text-[color:var(--oc-accent)]">
      <Content />
    </div>

    <!-- Tags -->
    {tags.length > 0 && (
      <footer class="mt-12 border-t border-[color:var(--oc-border)] pt-8">
        <h2 class="mb-4 text-lg font-semibold text-[color:var(--oc-text)]">Etiquetas</h2>
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <a
              href={`/tags/${tag.toLowerCase()}`}
              class="inline-block rounded-full px-4 py-2 text-sm transition-colors"
              style="background: var(--oc-surface-raised); color: var(--oc-text); border: 1px solid var(--oc-border);"
            >
              #{tag}
            </a>
          ))}
        </div>
      </footer>
    )}
  </article>
</BaseLayout>
