---
import BaseLayout from '../../layouts/BaseLayout.astro';
import JsonLd from '../../components/seo/JsonLd.astro';
import ShareButtons from '../../components/ui/ShareButtons.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const features = await getCollection('features', ({ data }) => !data.draft);
  return features.map((feature) => ({
    params: { slug: feature.slug },
    props: { feature },
  }));
}

const { feature } = Astro.props;
const { Content } = await feature.render();

const {
  title,
  descriptionEs,
  category,
  countries,
  latamHook,
  heroImage,
  heroImageAlt,
  publishDate,
  author,
  tags,
  blocks,
  seoMeta,
} = feature.data;

// SEO meta with fallbacks
const seoTitle = seoMeta?.title || title;
const seoDescription = seoMeta?.description || descriptionEs;
const ogImage = seoMeta?.ogImage || heroImage;

const formattedDate = publishDate.toLocaleDateString('es-419', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Category labels and colors
const categoryConfig: Record<string, { label: string; color: string }> = {
  music: { label: 'Música', color: 'bg-purple-100 text-purple-800' },
  series: { label: 'Series', color: 'bg-pink-100 text-pink-800' },
  event: { label: 'Evento', color: 'bg-blue-100 text-blue-800' },
  gastronomy: { label: 'Gastronomía', color: 'bg-orange-100 text-orange-800' },
  culture: { label: 'Cultura', color: 'bg-teal-100 text-teal-800' },
};

const categoryInfo = categoryConfig[category] || categoryConfig.culture;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  image={ogImage}
  imageAlt={heroImageAlt || title}
  type="article"
  publishedTime={publishDate}
  author={author}
>
  <Fragment slot="head">
    <JsonLd
      schema={[
        {
          type: 'Article',
          headline: title,
          description: descriptionEs,
          image: heroImage,
          datePublished: publishDate,
          author,
        },
        {
          type: 'BreadcrumbList',
          items: [
            { name: 'Inicio', url: '/' },
            { name: 'Features', url: '/features' },
            { name: title, url: Astro.url.pathname },
          ],
        },
      ]}
    />
  </Fragment>

  <article class="mx-auto max-w-4xl px-4 py-12 sm:px-6 lg:px-8" data-pagefind-body>
    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" class="mb-6">
      <ol class="flex flex-wrap items-center gap-2 text-sm text-gray-600">
        <li><a href="/" class="hover:text-pink-600">Inicio</a></li>
        <li>/</li>
        <li><a href="/features" class="hover:text-pink-600">Features</a></li>
        <li>/</li>
        <li class="text-gray-400" aria-current="page">{title}</li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <span class={`inline-block rounded-full px-3 py-1 text-xs font-medium ${categoryInfo.color}`}>
          {categoryInfo.label}
        </span>
        {countries.map((country) => (
          <span class="inline-block rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700">
            {country}
          </span>
        ))}
      </div>

      <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl lg:text-5xl" data-pagefind-meta="title">
        {title}
      </h1>

      <p class="mt-4 text-lg text-gray-600">{descriptionEs}</p>

      <span data-pagefind-meta="description" class="hidden">{descriptionEs}</span>
      <span data-pagefind-meta="contentType" data-pagefind-filter="contentType" class="hidden">features</span>
      <span data-pagefind-meta="pubDate" class="hidden">{publishDate.toISOString()}</span>
      {heroImage && <span data-pagefind-meta="heroImage" class="hidden">{heroImage}</span>}

      <div class="flex flex-wrap items-center gap-4 mt-4 text-sm text-gray-600">
        <span>Por {author}</span>
        <span>•</span>
        <time datetime={publishDate.toISOString()}>{formattedDate}</time>
      </div>

      <!-- Share Buttons -->
      <div class="mt-4">
        <ShareButtons
          title={title}
          url={`https://ondacoreana.com${Astro.url.pathname}`}
          description={descriptionEs}
        />
      </div>

      <!-- LatAm Hooks -->
      {latamHook.length > 0 && (
        <div class="mt-6 rounded-lg bg-gradient-to-r from-pink-50 to-purple-50 p-4">
          <h2 class="text-sm font-semibold text-gray-700 mb-2">Destacado para LatAm:</h2>
          <div class="flex flex-wrap gap-2">
            {latamHook.map((hook) => (
              <span class="inline-block rounded-full bg-white px-3 py-1 text-sm text-pink-700 shadow-sm">
                {hook}
              </span>
            ))}
          </div>
        </div>
      )}
    </header>

    <!-- Hero Image -->
    {heroImage && (
      <figure class="mb-8">
        <img
          src={heroImage}
          alt={heroImageAlt || title}
          class="w-full rounded-xl object-cover shadow-lg"
          loading="eager"
        />
      </figure>
    )}

    <!-- Content Blocks -->
    {blocks.length > 0 && (
      <div class="mb-8 space-y-6">
        {blocks.map((block) => (
          <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            {block.heading && (
              <h2 class="text-lg font-semibold text-gray-900 mb-2">{block.heading}</h2>
            )}
            <p class="text-gray-700">{block.body}</p>
          </div>
        ))}
      </div>
    )}

    <!-- MDX Content -->
    <div class="prose prose-lg prose-pink mx-auto max-w-none">
      <Content />
    </div>

    <!-- Tags -->
    {tags.length > 0 && (
      <footer class="mt-12 border-t border-gray-200 pt-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Etiquetas</h2>
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <a
              href={`/tags/${tag.toLowerCase()}`}
              class="inline-block rounded-full bg-gray-100 px-4 py-2 text-sm text-gray-700 hover:bg-pink-100 hover:text-pink-700 transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
      </footer>
    )}
  </article>
</BaseLayout>
