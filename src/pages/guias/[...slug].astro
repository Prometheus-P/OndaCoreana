---
import { type CollectionEntry, getCollection } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { autolinkHtml, buildKeywordLinks } from '../../lib/autolink';
import { getRelatedEntries, loadAllArticles } from '../../lib/related';

export async function getStaticPaths() {
  const guias = await getCollection('guias');
  return guias.map((guia) => ({
    params: { slug: guia.slug },
    props: guia,
  }));
}

type Props = CollectionEntry<'guias'>;

const guia = Astro.props;
const { Content } = await guia.render();
const allArticles = await loadAllArticles();
const relatedItems = getRelatedEntries(guia, allArticles);
const keywordLinks = buildKeywordLinks(
  allArticles.filter((entry) => entry.collection === 'guias') as CollectionEntry<'guias'>[],
  guia.slug
);
---

<ArticleLayout
  title={guia.data.title}
  description={guia.data.description}
  pubDate={guia.data.pubDate}
  updatedDate={guia.data.updatedDate}
  heroImage={guia.data.heroImage}
  heroImageAlt={guia.data.heroImageAlt}
  author={guia.data.author}
  tags={guia.data.tags}
  keywords={guia.data.keywords}
  breadcrumbs={[
    { name: 'GuÃ­as', url: '/guias' },
    { name: guia.data.category, url: `/guias/categoria/${guia.data.category}` },
  ]}
  contentType="guias"
  affiliateHint={guia.data.affiliate_hint}
  noAds={guia.data.noAds}
  relatedItems={relatedItems}
>
  <!-- Guide Meta Info -->
  {(guia.data.difficulty || guia.data.readingTime) && (
    <aside class="not-prose mb-8 flex flex-wrap gap-4 text-sm" style="color: var(--md-color-on-surface);">
      {guia.data.difficulty && (
        <div class="flex items-center gap-2">
          <span class="font-medium" style="color: var(--md-color-on-surface-variant);">Nivel:</span>
          <span class="chip capitalize" style="--chip-bg: color-mix(in srgb, var(--md-color-tertiary) 15%, transparent); --chip-color: var(--md-color-on-tertiary-container);">
            {guia.data.difficulty}
          </span>
        </div>
      )}
      {guia.data.readingTime && (
        <div class="flex items-center gap-2">
          <span class="font-medium" style="color: var(--md-color-on-surface-variant);">Tiempo de lectura:</span>
          <span>{guia.data.readingTime} minutos</span>
        </div>
      )}
    </aside>
  )}

  <Content />

  {keywordLinks.length > 0 && (
    <script type="module" is:inline define:vars={{ keywordLinks }}>
      import { autolinkHtml } from '../../lib/autolink';

      const article = document.querySelector('.prose');

      if (article instanceof HTMLElement) {
        const updated = autolinkHtml(article.innerHTML, keywordLinks);
        if (updated !== article.innerHTML) {
          article.innerHTML = updated;
        }
      }
    </script>
  )}
</ArticleLayout>
