---
import type { ContentType } from '../../types/search';

interface Props {
  activeFilter?: ContentType;
  query?: string;
}

const { activeFilter = 'all', query = '' } = Astro.props;

// Filter options with labels and colors
const filters: { type: ContentType; label: string; testId: string }[] = [
  { type: 'all', label: 'Todos', testId: 'filter-all' },
  { type: 'dramas', label: 'K-Dramas', testId: 'filter-dramas' },
  { type: 'kpop', label: 'K-Pop', testId: 'filter-kpop' },
  { type: 'noticias', label: 'Noticias', testId: 'filter-noticias' },
  { type: 'guias', label: 'Gu√≠as', testId: 'filter-guias' },
];

// Get the base URL with query parameter
function getFilterUrl(filterType: ContentType): string {
  const params = new URLSearchParams();
  if (query) params.set('q', query);
  if (filterType !== 'all') params.set('type', filterType);
  return `/buscar?${params.toString()}`;
}
---

<div class="search-filters" data-testid="search-filters" role="tablist" aria-label="Filtrar por tipo de contenido">
  <div class="flex flex-wrap gap-2">
    {filters.map((filter) => (
      <a
        href={getFilterUrl(filter.type)}
        class="filter-tab chip"
        data-testid={filter.testId}
        data-filter-type={filter.type}
        role="tab"
        aria-selected={activeFilter === filter.type ? 'true' : 'false'}
        aria-controls="search-results"
        data-active={activeFilter === filter.type ? 'true' : 'false'}
      >
        {filter.label}
        <span class="filter-count ml-1 hidden" data-filter-count={filter.type}></span>
      </a>
    ))}
  </div>
</div>

<style>
  .filter-tab {
    border: 1px solid color-mix(in srgb, var(--md-color-outline) 60%, transparent);
    transition: background-color var(--md-motion-duration-short) var(--md-motion-easing-standard), color var(--md-motion-duration-short) var(--md-motion-easing-standard), border-color var(--md-motion-duration-short) var(--md-motion-easing-standard), box-shadow var(--md-motion-duration-short) var(--md-motion-easing-standard);
  }

  .filter-tab[data-active="true"] {
    background-color: var(--md-color-primary);
    color: var(--md-color-on-primary);
    border-color: transparent;
    box-shadow: var(--md-elevation-1);
  }

  .filter-tab[data-active="false"] {
    background-color: var(--md-color-surface-variant);
    color: var(--md-color-on-surface-variant);
  }

  .filter-tab[data-active="false"]:hover {
    background-color: color-mix(in srgb, var(--md-color-primary) 14%, var(--md-color-surface-variant));
    border-color: var(--md-color-primary);
  }

  .filter-tab:focus-visible {
    outline: 2px solid var(--md-color-primary);
    outline-offset: 2px;
  }
</style>

<script>
  // Handle filter clicks with JavaScript for SPA-like behavior
  document.querySelectorAll('[data-testid="search-filters"] a').forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = (e.currentTarget as HTMLAnchorElement).href;

      // Update URL without full page reload
      window.history.pushState({}, '', href);

      // Trigger a custom event that buscar.astro can listen to
      window.dispatchEvent(new CustomEvent('filterchange', {
        detail: { url: href }
      }));
    });
  });
</script>
