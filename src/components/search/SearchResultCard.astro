---
import type { SearchResult } from '../../types/search';
import { contentTypeLabels } from '../../types/search';

interface Props {
  result: SearchResult;
  query: string;
}

const { result, query } = Astro.props;

function escapeRegex(value: string): string {
  return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Highlight query terms in excerpt
function highlightExcerpt(excerpt: string, query: string): string {
  if (!query.trim()) return excerpt;
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return excerpt.replace(regex, '<mark class="search-highlight">$1</mark>');
}

// Format date in Spanish locale
const formattedDate = result.pubDate.toLocaleDateString('es-419', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Badge styles per content type
const typeStyles: Record<string, { bg: string; color: string }> = {
  dramas: { bg: 'var(--md-color-primary-container)', color: 'var(--md-color-on-primary-container)' },
  kpop: { bg: 'var(--md-color-tertiary-container)', color: 'var(--md-color-on-tertiary-container)' },
  noticias: { bg: 'var(--md-color-secondary-container)', color: 'var(--md-color-on-secondary-container)' },
  guias: { bg: 'color-mix(in srgb, var(--md-color-tertiary) 15%, var(--md-color-surface-variant))', color: 'var(--md-color-on-surface)' },
  all: { bg: 'var(--md-color-surface-variant)', color: 'var(--md-color-on-surface-variant)' },
};

const badgeColors = typeStyles[result.contentType] || typeStyles.all;
const typeLabel = contentTypeLabels[result.contentType] || result.contentType;
---

<article class="search-result-card group" data-testid="search-result-card">
  <a
    href={result.url}
    class="block"
    style="border-radius: var(--md-shape-lg); border: 1px solid var(--md-color-outline-variant); background-color: var(--md-color-surface-container-low); padding: var(--md-sys-spacing-md); transition: all var(--md-motion-duration-short) var(--md-motion-easing-standard);"
    onmouseover="this.style.borderColor='var(--md-color-primary)'; this.style.boxShadow='var(--md-elevation-2)'; this.style.transform='translateY(-2px)';"
    onmouseout="this.style.borderColor='var(--md-color-outline-variant)'; this.style.boxShadow='none'; this.style.transform='none';"
  >
    <div class="flex" style="gap: var(--md-sys-spacing-md);">
      {result.heroImage && (
        <div class="hidden sm:block flex-shrink-0">
          <img
            src={result.heroImage}
            alt=""
            class="h-24 w-24 object-cover"
            style="border-radius: var(--md-sys-shape-corner-medium);"
            loading="lazy"
            decoding="async"
          />
        </div>
      )}

      <div class="flex-1 min-w-0">
        <div class="flex items-center" style="gap: var(--md-sys-spacing-sm); margin-bottom: var(--md-sys-spacing-sm);">
          <span
            class="chip"
            style={`--chip-bg: ${badgeColors.bg}; --chip-color: ${badgeColors.color}; text-transform: capitalize;`}
            data-testid="result-type"
          >
            {typeLabel}
          </span>
        </div>

        <h3
          class="text-lg font-semibold line-clamp-2"
          style="color: var(--md-sys-color-on-surface);"
          data-testid="result-title"
        >
          {result.title}
        </h3>

        <p
          class="text-sm line-clamp-2"
          style="margin-top: var(--md-sys-spacing-xs); color: var(--md-sys-color-on-surface-variant);"
          data-testid="result-excerpt"
          set:html={highlightExcerpt(result.excerpt, query)}
        />

        <time
          datetime={result.pubDate.toISOString()}
          class="block text-xs"
          style="margin-top: var(--md-sys-spacing-sm); color: var(--md-sys-color-on-surface-variant); opacity: 0.7;"
          data-testid="result-date"
        >
          {formattedDate}
        </time>
      </div>
    </div>
  </a>
</article>

<style>
  .search-highlight {
    background-color: color-mix(in srgb, var(--md-color-primary) 25%, transparent);
    color: var(--md-color-on-surface);
    border-radius: var(--md-shape-sm);
    padding: 0 var(--md-spacing-xxs, 0.125rem);
  }
</style>
