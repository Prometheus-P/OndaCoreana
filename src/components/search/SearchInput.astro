---
interface Props {
  placeholder?: string;
  initialValue?: string;
  size?: 'sm' | 'md' | 'lg';
  showInlineResults?: boolean;
}

const {
  placeholder = 'Buscar...',
  initialValue = '',
  size = 'md',
  showInlineResults = true
} = Astro.props;

// Size classes for different variants
const sizeClasses = {
  sm: 'h-8 text-sm px-3',
  md: 'h-11 text-base px-4',
  lg: 'h-12 text-lg px-5',
};

const inputSize = sizeClasses[size];

// Generate unique ID for this instance
const instanceId = Math.random().toString(36).substring(2, 9);
---

<div class="search-wrapper relative" data-search-wrapper data-instance-id={instanceId} data-testid="site-search">
  <form
    action="/buscar"
    method="GET"
    class="search-form relative"
    data-testid="search-form"
  >
    <label for={`search-input-${instanceId}`} class="sr-only">Buscar contenido</label>
    <div class="relative">
      <input
        type="search"
        id={`search-input-${instanceId}`}
        name="q"
        placeholder={placeholder}
        value={initialValue}
        minlength="2"
        maxlength="100"
        class={`input-field pr-12 ${inputSize}`}
        data-testid="site-search-input"
        autocomplete="off"
        aria-label="Buscar contenido"
        aria-expanded="false"
        aria-controls={`search-dropdown-${instanceId}`}
        aria-autocomplete="list"
        role="combobox"
      />
      <button
        type="submit"
        class="icon-button absolute right-2 top-1/2 -translate-y-1/2"
        aria-label="Buscar"
        data-testid="search-submit"
      >
        <svg
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </button>
    </div>
  </form>

  {/* Inline results dropdown */}
  {showInlineResults && (
    <div
      id={`search-dropdown-${instanceId}`}
      class="search-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden max-h-96 overflow-y-auto rounded-2xl"
      style="border: 1px solid var(--md-color-outline-variant); background-color: var(--md-color-surface-container); box-shadow: var(--md-elevation-3);"
      data-testid="search-dropdown"
      role="listbox"
      aria-label="Resultados de búsqueda"
    >
      {/* Loading state */}
      <div class="search-loading hidden p-4 text-center" data-testid="search-loading-inline" style="color: var(--md-color-primary);">
        <svg class="mx-auto h-5 w-5 animate-spin" viewBox="0 0 24 24">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
            fill="none"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
        <p style="margin-top: var(--md-spacing-xs); font-size: var(--md-typo-body-medium-size); color: var(--md-color-on-surface-variant);">Buscando...</p>
      </div>

      {/* Error state */}
      <div class="search-error hidden p-4 text-center" data-testid="search-error" style="color: var(--md-color-error);">
        <svg class="mx-auto h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <p style="margin-top: var(--md-spacing-xs); font-size: var(--md-typo-body-medium-size);">Error en la búsqueda. Intenta de nuevo.</p>
      </div>

      {/* Results container */}
      <div class="search-results-inline hidden" data-testid="search-results-inline">
        {/* Results will be populated by JavaScript */}
      </div>

      {/* No results state */}
      <div class="search-no-results hidden p-4 text-center" data-testid="search-no-results-inline">
        <p class="text-sm subtle-text">No se encontraron resultados</p>
      </div>

      {/* View all results link */}
      <div class="search-view-all hidden border-t" data-testid="search-view-all-container" style="border-color: var(--md-color-outline-variant);">
        <a
          href="/buscar"
          class="block rounded-b-2xl px-3 py-2 text-center text-sm font-medium"
          style="color: var(--md-color-primary);"
          data-testid="view-all-results"
        >
          Ver todos los resultados
        </a>
      </div>
    </div>
  )}
</div>

<script>
  import { debounce } from '../../utils/debounce';
  import { escapeHtml, highlightMatch, contentTypeLabels, contentTypeStyles } from '../../utils/search-client';

  // Types
  type ContentType = 'all' | 'dramas' | 'kpop' | 'noticias' | 'guias';

  interface SearchResult {
    title: string;
    excerpt: string;
    url: string;
    contentType: ContentType;
  }

  // Pagefind types (inline for browser runtime)
  interface PagefindResultMeta {
    title?: string;
    description?: string;
    contentType?: string;
  }

  interface PagefindResultData {
    url: string;
    excerpt: string;
    meta: PagefindResultMeta;
  }

  interface PagefindResult {
    data: () => Promise<PagefindResultData>;
  }

  interface PagefindSearchResponse {
    results: PagefindResult[];
  }

  interface PagefindInstance {
    init: () => Promise<void>;
    search: (query: string) => Promise<PagefindSearchResponse>;
  }

  // Pagefind instance (shared across all search inputs)
  let pagefindInstance: PagefindInstance | null = null;
  // pagefindLoading tracked via pagefindLoadPromise
  let pagefindLoadPromise: Promise<PagefindInstance> | null = null;
  let shortcutRegistered = false;

  async function loadPagefind() {
    if (pagefindInstance) return pagefindInstance;
    if (pagefindLoadPromise) return pagefindLoadPromise;

    pagefindLoadPromise = (async () => {
      try {
        const pagefindPath = '/pagefind/pagefind.js';
        const pagefind = await import(/* @vite-ignore */ pagefindPath);
        await pagefind.init();
        pagefindInstance = pagefind;
        return pagefind;
      } catch (error) {
        console.error('Failed to load Pagefind:', error);
        throw error;
      }
    })();

    return pagefindLoadPromise;
  }

  // Initialize each search wrapper
  function initSearchWrapper(wrapper: HTMLElement) {
    const input = wrapper.querySelector('[data-testid="site-search-input"]') as HTMLInputElement;
    const form = wrapper.querySelector('[data-testid="search-form"]') as HTMLFormElement;
    const dropdown = wrapper.querySelector('[data-testid="search-dropdown"]') as HTMLElement;

    if (!input || !form) return;
    if (!dropdown) {
      // No inline results for this instance
      initFormValidation(form, input);
      return;
    }

    const loadingEl = dropdown.querySelector('[data-testid="search-loading-inline"]') as HTMLElement;
    const resultsEl = dropdown.querySelector('[data-testid="search-results-inline"]') as HTMLElement;
    const noResultsEl = dropdown.querySelector('[data-testid="search-no-results-inline"]') as HTMLElement;
    const errorEl = dropdown.querySelector('[data-testid="search-error"]') as HTMLElement;
    const viewAllContainer = dropdown.querySelector('[data-testid="search-view-all-container"]') as HTMLElement;
    const viewAllLink = dropdown.querySelector('[data-testid="view-all-results"]') as HTMLAnchorElement;

    let isOpen = false;
    let currentQuery = '';

    // Show dropdown
    function showDropdown() {
      if (!isOpen) {
        dropdown.classList.remove('hidden');
        input.setAttribute('aria-expanded', 'true');
        isOpen = true;
      }
    }

    // Hide dropdown
    function hideDropdown() {
      if (isOpen) {
        dropdown.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        isOpen = false;
      }
    }

    // Show loading state
    function showLoading() {
      loadingEl.classList.remove('hidden');
      resultsEl.classList.add('hidden');
      noResultsEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      viewAllContainer.classList.add('hidden');
    }

    // Show error state
    function showError() {
      loadingEl.classList.add('hidden');
      resultsEl.classList.add('hidden');
      noResultsEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      viewAllContainer.classList.add('hidden');
    }

    // Show results
    function showResults(results: SearchResult[], query: string) {
      loadingEl.classList.add('hidden');
      noResultsEl.classList.add('hidden');
      errorEl.classList.add('hidden');

      if (results.length > 0) {
        resultsEl.innerHTML = results
          .slice(0, 5)
          .map((result) => renderDropdownResult(result, query))
          .join('');
        resultsEl.classList.remove('hidden');
        viewAllContainer.classList.remove('hidden');
        viewAllLink.href = `/buscar?q=${encodeURIComponent(query)}`;
      } else {
        resultsEl.classList.add('hidden');
        noResultsEl.classList.remove('hidden');
        viewAllContainer.classList.add('hidden');
      }
    }

    // Render a dropdown result item
    function renderDropdownResult(result: SearchResult, query: string): string {
      const typeLabel = contentTypeLabels[result.contentType] || contentTypeLabels.all;
      const typeColor = contentTypeStyles[result.contentType] || contentTypeStyles.all;
      const highlightedTitle = highlightMatch(result.title, query);
      const highlightedExcerpt = highlightMatch(result.excerpt, query);

      return `
        <a
          href="${escapeHtml(result.url)}"
          class="dropdown-result"
          data-testid="dropdown-result"
          role="option"
        >
          <div class="flex items-start gap-2">
            <span class="chip shrink-0 mt-0.5" style="--chip-bg: ${typeColor.bg}; --chip-color: ${typeColor.color};">
              ${typeLabel}
            </span>
            <div class="min-w-0">
              <p class="dropdown-result__title">${highlightedTitle}</p>
              <p class="dropdown-result__excerpt">${highlightedExcerpt}</p>
            </div>
          </div>
        </a>
      `;
    }

    // Perform search
    async function performSearch(query: string) {
      currentQuery = query;

      if (query.length < 2) {
        hideDropdown();
        return;
      }

      showDropdown();
      showLoading();

      try {
        const pagefind = await loadPagefind();
        const search = await pagefind.search(query);

        // Check if query changed while searching
        if (currentQuery !== query) return;

        // Load result data (first 5 for dropdown)
        const resultsData = await Promise.all(
          search.results.slice(0, 5).map((result) => result.data())
        );

        // Transform results
        const results: SearchResult[] = resultsData.map((data) => ({
          title: data.meta?.title || 'Sin título',
          excerpt: data.excerpt || data.meta?.description || '',
          url: data.url,
          contentType: (data.meta?.contentType as ContentType) || 'all',
        }));

        // Check again if query changed
        if (currentQuery !== query) return;

        showResults(results, query);
      } catch (error) {
        console.error('Search error:', error);
        showError();
      }
    }

    // Debounced search (300ms)
    const debouncedSearch = debounce(performSearch, 300);

    // Input event - trigger real-time search
    input.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      debouncedSearch(query);
    });

    // Focus event - show dropdown if there's a query
    input.addEventListener('focus', () => {
      const query = input.value.trim();
      if (query.length >= 2) {
        performSearch(query);
      }
    });

    // Click outside to close
    document.addEventListener('click', (e) => {
      if (!wrapper.contains(e.target as Node)) {
        hideDropdown();
      }
    });

    // Escape key to close
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideDropdown();
        input.blur();
      }
    });

    // Form validation
    initFormValidation(form, input);
  }

  // Form validation (shared logic)
  function initFormValidation(form: HTMLFormElement, input: HTMLInputElement) {
    form.addEventListener('submit', (e) => {
      const query = input.value.trim();

      // Require minimum 2 non-whitespace characters (FR-016)
      if (query.length < 2) {
        e.preventDefault();
        input.focus();
        return;
      }

      // Truncate at 100 characters (FR-015)
      if (query.length > 100) {
        input.value = query.substring(0, 100);
      }
    });
  }

  // Initialize all search wrappers on page load
  function initAllSearchWrappers() {
    document.querySelectorAll('[data-search-wrapper]').forEach((wrapper) => {
      initSearchWrapper(wrapper as HTMLElement);
    });

    registerSearchShortcut();
  }

  function registerSearchShortcut() {
    if (shortcutRegistered) return;
    shortcutRegistered = true;

    document.addEventListener('keydown', (event) => {
      if (event.key !== '/' || event.altKey || event.ctrlKey || event.metaKey) return;

      const target = event.target as HTMLElement | null;
      if (!target) return;

      const isEditable =
        target.tagName === 'INPUT' ||
        target.tagName === 'TEXTAREA' ||
        (target as HTMLElement).isContentEditable;

      if (isEditable) return;

      const firstInput = document.querySelector('[data-search-wrapper] [data-testid="site-search-input"]') as HTMLInputElement | null;

      if (firstInput) {
        event.preventDefault();
        firstInput.focus();
        firstInput.select();
      }
    });
  }

  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllSearchWrappers);
  } else {
    initAllSearchWrappers();
  }
</script>

<style>
  .dropdown-result {
    display: block;
    padding: var(--md-spacing-sm) var(--md-spacing-lg);
    border-bottom: 1px solid color-mix(in srgb, var(--md-color-outline-variant) 70%, transparent);
    transition: background-color var(--md-motion-duration-short) var(--md-motion-easing-standard);
  }

  .dropdown-result:last-of-type {
    border-bottom: none;
  }

  .dropdown-result:hover {
    background-color: color-mix(in srgb, var(--md-color-primary) 12%, transparent);
  }

  .dropdown-result__title {
    font-size: var(--md-typo-body-medium-size);
    font-weight: 600;
    color: var(--md-color-on-surface);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .dropdown-result__excerpt {
    font-size: var(--md-typo-label-medium-size);
    color: var(--md-color-on-surface-variant);
    margin-top: var(--md-spacing-xxs, 0.25rem);
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-highlight {
    background-color: color-mix(in srgb, var(--md-color-primary) 25%, transparent);
    color: var(--md-color-on-surface);
    border-radius: var(--md-shape-sm);
    padding: 0 var(--md-spacing-xxs, 0.125rem);
  }
</style>
