---
interface Props {
  placeholder?: string;
  initialValue?: string;
  size?: 'sm' | 'md' | 'lg';
  showInlineResults?: boolean;
}

const {
  placeholder = 'Buscar...',
  initialValue = '',
  size = 'md',
  showInlineResults = true
} = Astro.props;

// Size classes for different variants
const sizeClasses = {
  sm: 'h-8 text-sm px-3',
  md: 'h-10 text-base px-4',
  lg: 'h-12 text-lg px-5',
};

const inputSize = sizeClasses[size];

// Generate unique ID for this instance
const instanceId = Math.random().toString(36).substring(2, 9);
---

<div class="search-wrapper relative" data-search-wrapper data-instance-id={instanceId}>
  <form
    action="/buscar"
    method="GET"
    class="search-form relative"
    data-testid="search-form"
  >
    <label for={`search-input-${instanceId}`} class="sr-only">Buscar contenido</label>
    <div class="relative">
      <input
        type="search"
        id={`search-input-${instanceId}`}
        name="q"
        placeholder={placeholder}
        value={initialValue}
        minlength="2"
        maxlength="100"
        class={`w-full rounded-lg border border-gray-300 bg-white pr-10 text-gray-900 placeholder-gray-500 transition-colors focus:border-pink-500 focus:outline-none focus:ring-2 focus:ring-pink-500/20 ${inputSize}`}
        data-testid="search-input"
        autocomplete="off"
        aria-label="Buscar contenido"
        aria-expanded="false"
        aria-controls={`search-dropdown-${instanceId}`}
        aria-autocomplete="list"
        role="combobox"
      />
      <button
        type="submit"
        class="absolute right-2 top-1/2 -translate-y-1/2 rounded-md p-1.5 text-gray-400 transition-colors hover:text-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-500"
        aria-label="Buscar"
        data-testid="search-submit"
      >
        <svg
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </button>
    </div>
  </form>

  {/* Inline results dropdown */}
  {showInlineResults && (
    <div
      id={`search-dropdown-${instanceId}`}
      class="search-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden max-h-96 overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-lg"
      data-testid="search-dropdown"
      role="listbox"
      aria-label="Resultados de búsqueda"
    >
      {/* Loading state */}
      <div class="search-loading hidden p-4 text-center" data-testid="search-loading-inline">
        <svg class="mx-auto h-5 w-5 animate-spin text-pink-600" viewBox="0 0 24 24">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
            fill="none"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
        <p class="mt-2 text-sm text-gray-500">Buscando...</p>
      </div>

      {/* Results container */}
      <div class="search-results-inline hidden" data-testid="search-results-inline">
        {/* Results will be populated by JavaScript */}
      </div>

      {/* No results state */}
      <div class="search-no-results hidden p-4 text-center" data-testid="search-no-results-inline">
        <p class="text-sm text-gray-500">No se encontraron resultados</p>
      </div>

      {/* View all results link */}
      <div class="search-view-all hidden border-t border-gray-100 p-2" data-testid="search-view-all-container">
        <a
          href="/buscar"
          class="block rounded-md px-3 py-2 text-center text-sm font-medium text-pink-600 hover:bg-pink-50 transition-colors"
          data-testid="view-all-results"
        >
          Ver todos los resultados
        </a>
      </div>
    </div>
  )}
</div>

<script>
  // Types
  type ContentType = 'all' | 'dramas' | 'kpop' | 'noticias' | 'guias';

  interface SearchResult {
    title: string;
    excerpt: string;
    url: string;
    contentType: ContentType;
  }

  // Debounce utility
  function debounce<T extends (...args: any[]) => any>(
    func: T,
    wait: number
  ): (...args: Parameters<T>) => void {
    let timeoutId: ReturnType<typeof setTimeout> | null = null;

    return function (this: any, ...args: Parameters<T>) {
      if (timeoutId !== null) {
        clearTimeout(timeoutId);
      }

      timeoutId = setTimeout(() => {
        func.apply(this, args);
        timeoutId = null;
      }, wait);
    };
  }

  // Content type labels
  const typeLabels: Record<string, string> = {
    dramas: 'K-Drama',
    kpop: 'K-Pop',
    noticias: 'Noticia',
    guias: 'Guía',
    all: 'Contenido',
  };

  // Content type colors
  const typeColors: Record<string, string> = {
    dramas: 'bg-pink-100 text-pink-800',
    kpop: 'bg-purple-100 text-purple-800',
    noticias: 'bg-blue-100 text-blue-800',
    guias: 'bg-teal-100 text-teal-800',
    all: 'bg-gray-100 text-gray-800',
  };

  // Pagefind instance (shared across all search inputs)
  let pagefindInstance: any = null;
  let pagefindLoading = false;
  let pagefindLoadPromise: Promise<any> | null = null;

  async function loadPagefind() {
    if (pagefindInstance) return pagefindInstance;
    if (pagefindLoadPromise) return pagefindLoadPromise;

    pagefindLoading = true;
    pagefindLoadPromise = (async () => {
      try {
        const pagefindPath = '/pagefind/pagefind.js';
        const pagefind = await import(/* @vite-ignore */ pagefindPath);
        await pagefind.init();
        pagefindInstance = pagefind;
        return pagefind;
      } catch (error) {
        console.error('Failed to load Pagefind:', error);
        throw error;
      } finally {
        pagefindLoading = false;
      }
    })();

    return pagefindLoadPromise;
  }

  // Escape HTML
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initialize each search wrapper
  function initSearchWrapper(wrapper: HTMLElement) {
    const instanceId = wrapper.dataset.instanceId;
    const input = wrapper.querySelector('[data-testid="search-input"]') as HTMLInputElement;
    const form = wrapper.querySelector('[data-testid="search-form"]') as HTMLFormElement;
    const dropdown = wrapper.querySelector('[data-testid="search-dropdown"]') as HTMLElement;

    if (!input || !form) return;
    if (!dropdown) {
      // No inline results for this instance
      initFormValidation(form, input);
      return;
    }

    const loadingEl = dropdown.querySelector('[data-testid="search-loading-inline"]') as HTMLElement;
    const resultsEl = dropdown.querySelector('[data-testid="search-results-inline"]') as HTMLElement;
    const noResultsEl = dropdown.querySelector('[data-testid="search-no-results-inline"]') as HTMLElement;
    const viewAllContainer = dropdown.querySelector('[data-testid="search-view-all-container"]') as HTMLElement;
    const viewAllLink = dropdown.querySelector('[data-testid="view-all-results"]') as HTMLAnchorElement;

    let isOpen = false;
    let currentQuery = '';

    // Show dropdown
    function showDropdown() {
      if (!isOpen) {
        dropdown.classList.remove('hidden');
        input.setAttribute('aria-expanded', 'true');
        isOpen = true;
      }
    }

    // Hide dropdown
    function hideDropdown() {
      if (isOpen) {
        dropdown.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        isOpen = false;
      }
    }

    // Show loading state
    function showLoading() {
      loadingEl.classList.remove('hidden');
      resultsEl.classList.add('hidden');
      noResultsEl.classList.add('hidden');
      viewAllContainer.classList.add('hidden');
    }

    // Show results
    function showResults(results: SearchResult[], query: string) {
      loadingEl.classList.add('hidden');
      noResultsEl.classList.add('hidden');

      if (results.length > 0) {
        resultsEl.innerHTML = results.slice(0, 5).map(result => renderDropdownResult(result)).join('');
        resultsEl.classList.remove('hidden');
        viewAllContainer.classList.remove('hidden');
        viewAllLink.href = `/buscar?q=${encodeURIComponent(query)}`;
      } else {
        resultsEl.classList.add('hidden');
        noResultsEl.classList.remove('hidden');
        viewAllContainer.classList.add('hidden');
      }
    }

    // Render a dropdown result item
    function renderDropdownResult(result: SearchResult): string {
      const typeLabel = typeLabels[result.contentType] || typeLabels.all;
      const typeColor = typeColors[result.contentType] || typeColors.all;

      return `
        <a
          href="${escapeHtml(result.url)}"
          class="dropdown-result block px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-b-0"
          data-testid="dropdown-result"
          role="option"
        >
          <div class="flex items-start gap-2">
            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${typeColor} shrink-0 mt-0.5">
              ${typeLabel}
            </span>
            <div class="min-w-0">
              <p class="text-sm font-medium text-gray-900 line-clamp-1">${escapeHtml(result.title)}</p>
              <p class="text-xs text-gray-500 line-clamp-1 mt-0.5">${escapeHtml(result.excerpt)}</p>
            </div>
          </div>
        </a>
      `;
    }

    // Perform search
    async function performSearch(query: string) {
      currentQuery = query;

      if (query.length < 2) {
        hideDropdown();
        return;
      }

      showDropdown();
      showLoading();

      try {
        const pagefind = await loadPagefind();
        const search = await pagefind.search(query);

        // Check if query changed while searching
        if (currentQuery !== query) return;

        // Load result data (first 5 for dropdown)
        const resultsData = await Promise.all(
          search.results.slice(0, 5).map((result: any) => result.data())
        );

        // Transform results
        const results: SearchResult[] = resultsData.map((data: any) => ({
          title: data.meta?.title || 'Sin título',
          excerpt: data.excerpt || data.meta?.description || '',
          url: data.url,
          contentType: (data.meta?.contentType as ContentType) || 'all',
        }));

        // Check again if query changed
        if (currentQuery !== query) return;

        showResults(results, query);
      } catch (error) {
        console.error('Search error:', error);
        hideDropdown();
      }
    }

    // Debounced search (300ms)
    const debouncedSearch = debounce(performSearch, 300);

    // Input event - trigger real-time search
    input.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      debouncedSearch(query);
    });

    // Focus event - show dropdown if there's a query
    input.addEventListener('focus', () => {
      const query = input.value.trim();
      if (query.length >= 2) {
        performSearch(query);
      }
    });

    // Click outside to close
    document.addEventListener('click', (e) => {
      if (!wrapper.contains(e.target as Node)) {
        hideDropdown();
      }
    });

    // Escape key to close
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideDropdown();
        input.blur();
      }
    });

    // Form validation
    initFormValidation(form, input);
  }

  // Form validation (shared logic)
  function initFormValidation(form: HTMLFormElement, input: HTMLInputElement) {
    form.addEventListener('submit', (e) => {
      const query = input.value.trim();

      // Require minimum 2 non-whitespace characters (FR-016)
      if (query.length < 2) {
        e.preventDefault();
        input.focus();
        return;
      }

      // Truncate at 100 characters (FR-015)
      if (query.length > 100) {
        input.value = query.substring(0, 100);
      }
    });
  }

  // Initialize all search wrappers on page load
  function initAllSearchWrappers() {
    document.querySelectorAll('[data-search-wrapper]').forEach((wrapper) => {
      initSearchWrapper(wrapper as HTMLElement);
    });
  }

  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllSearchWrappers);
  } else {
    initAllSearchWrappers();
  }
</script>
