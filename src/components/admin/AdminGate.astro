---
const accessCode = import.meta.env.PUBLIC_ADMIN_ACCESS_CODE || '';
const redirectPath = Astro.props.redirect ?? '/admin/features';
---

<div class="card" id="admin-gate">
  <h2>Acceso administrador</h2>
  <p class="muted">Ingresa el código para continuar.</p>
  <form id="admin-gate-form">
    <label>
      Código de acceso
      <input type="password" name="code" required placeholder="••••••" />
    </label>
    <button type="submit">Desbloquear</button>
    <p class="error" hidden id="gate-error">Código inválido. Intenta de nuevo.</p>
  </form>
  <button type="button" id="logout-btn" hidden>Salir</button>
  <div id="admin-slot" hidden>
    <slot />
  </div>
</div>

<style>
  .card {
    background: #121a30;
    border: 1px solid #1f2a44;
    border-radius: 12px;
    padding: 16px;
  }
  h2 {
    margin: 0 0 8px 0;
  }
  .muted {
    color: #9ba3b5;
    margin-top: 0;
  }
  form {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  label {
    display: flex;
    flex-direction: column;
    font-size: 14px;
    color: #c7d0e5;
  }
  input {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #1f2a44;
    background: #0c1427;
    color: #e8ecf5;
    min-width: 200px;
  }
  button {
    background: linear-gradient(120deg, #9b87f5, #5dd39e);
    color: #0b1021;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }
  .error {
    color: #ff7787;
    font-size: 14px;
    margin: 0;
  }
</style>

<script define:vars={{ accessCode, redirectPath }}>
  const code = accessCode;
  const redirect = redirectPath;
  const SESSION_KEY = 'oc-admin-session';
  const ATTEMPTS_KEY = 'oc-admin-attempts';
  const LOCKOUT_KEY = 'oc-admin-lockout';
  const MAX_ATTEMPTS = 5;
  const LOCKOUT_DURATION = 5 * 60 * 1000; // 5 minutes in ms

  const form = document.getElementById('admin-gate-form');
  const slot = document.getElementById('admin-slot');
  const error = document.getElementById('gate-error');
  const logout = document.getElementById('logout-btn');
  const submitBtn = form?.querySelector('button[type="submit"]');

  // Rate limiting helpers
  const getAttempts = () => {
    const val = window.localStorage.getItem(ATTEMPTS_KEY);
    return val ? parseInt(val, 10) : 0;
  };

  const setAttempts = (count) => {
    window.localStorage.setItem(ATTEMPTS_KEY, count.toString());
  };

  const getLockoutTime = () => {
    const val = window.localStorage.getItem(LOCKOUT_KEY);
    return val ? parseInt(val, 10) : 0;
  };

  const setLockout = () => {
    window.localStorage.setItem(LOCKOUT_KEY, (Date.now() + LOCKOUT_DURATION).toString());
  };

  const clearLockout = () => {
    window.localStorage.removeItem(LOCKOUT_KEY);
    window.localStorage.removeItem(ATTEMPTS_KEY);
  };

  const isLockedOut = () => {
    const lockoutTime = getLockoutTime();
    if (!lockoutTime) return false;
    if (Date.now() < lockoutTime) return true;
    clearLockout();
    return false;
  };

  const getRemainingLockoutSeconds = () => {
    const lockoutTime = getLockoutTime();
    return Math.ceil((lockoutTime - Date.now()) / 1000);
  };

  const updateLockoutUI = () => {
    if (!isLockedOut()) return;
    const remaining = getRemainingLockoutSeconds();
    if (error) {
      error.textContent = `Demasiados intentos. Espera ${Math.ceil(remaining / 60)} minuto(s).`;
      error.removeAttribute('hidden');
    }
    if (submitBtn) submitBtn.disabled = true;
    setTimeout(updateLockoutUI, 1000);
  };

  const unlock = () => {
    if (!slot) return;
    form?.setAttribute('hidden', 'true');
    logout?.removeAttribute('hidden');
    error?.setAttribute('hidden', 'true');
    slot.removeAttribute('hidden');
    clearLockout();
  };

  const lock = () => {
    form?.removeAttribute('hidden');
    logout?.setAttribute('hidden', 'true');
    slot?.setAttribute('hidden', 'true');
    if (error) error.setAttribute('hidden', 'true');
  };

  // Check lockout on load
  if (isLockedOut()) {
    updateLockoutUI();
  }

  const stored = window.localStorage.getItem(SESSION_KEY);
  if (stored === code && code) {
    unlock();
    if (redirect && window.location.pathname === '/admin') {
      window.location.href = redirect;
    }
  }

  form?.addEventListener('submit', (event) => {
    event.preventDefault();
    if (!form) return;

    // Check lockout before processing
    if (isLockedOut()) {
      updateLockoutUI();
      return;
    }

    const formData = new FormData(form);
    const value = (formData.get('code') || '').toString().trim();

    if (value === code && code) {
      window.localStorage.setItem(SESSION_KEY, value);
      clearLockout();
      unlock();
      if (redirect && window.location.pathname === '/admin') {
        window.location.href = redirect;
      }
      return;
    }

    // Invalid attempt - increment counter
    const attempts = getAttempts() + 1;
    setAttempts(attempts);

    if (attempts >= MAX_ATTEMPTS) {
      setLockout();
      updateLockoutUI();
      return;
    }

    if (error) {
      error.textContent = `Código inválido. ${MAX_ATTEMPTS - attempts} intento(s) restante(s).`;
      error.removeAttribute('hidden');
    }
  });

  logout?.addEventListener('click', () => {
    window.localStorage.removeItem(SESSION_KEY);
    lock();
  });
</script>
