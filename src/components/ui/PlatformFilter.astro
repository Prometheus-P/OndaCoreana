---
/**
 * PlatformFilter Component
 * Streaming platform filter chips for drama listings
 * Enables "Where can I watch?" consumer demand
 */

import { latamPlatforms, type PlatformConfig } from '../../config/platforms';
import type { StreamingPlatform } from '../../utils/content-helpers';

interface Props {
  /** Currently selected platform (from URL param) */
  selectedPlatform?: StreamingPlatform | null;
  /** Drama count per platform */
  platformCounts?: Map<StreamingPlatform, number>;
  /** Total drama count (for "All" option) */
  totalCount?: number;
  /** Base URL for filter links */
  baseUrl?: string;
  /** Test ID for testing */
  testId?: string;
}

const {
  selectedPlatform = null,
  platformCounts = new Map(),
  totalCount = 0,
  baseUrl = '/dramas',
  testId,
} = Astro.props;

// Get count for a platform
function getCount(platformId: StreamingPlatform): number {
  return platformCounts.get(platformId) || 0;
}

// Check if a platform has content
function hasContent(platform: PlatformConfig): boolean {
  return getCount(platform.id) > 0;
}

// Get URL for filter
function getFilterUrl(platformId: StreamingPlatform | null): string {
  if (!platformId) return baseUrl;
  return `${baseUrl}?platform=${platformId}`;
}
---

<div class="platform-filter" data-testid={testId}>
  <div class="platform-filter__header">
    <h3 class="platform-filter__title">
      <span class="platform-filter__icon">ðŸ“º</span>
      Â¿DÃ³nde quieres ver?
    </h3>
    {selectedPlatform && (
      <span class="platform-filter__count">
        {getCount(selectedPlatform)} dramas disponibles
      </span>
    )}
  </div>

  <div class="platform-filter__chips">
    <a
      href={getFilterUrl(null)}
      class:list={[
        'platform-chip',
        { 'platform-chip--active': !selectedPlatform },
      ]}
    >
      <span class="platform-chip__icon">ðŸŽ¬</span>
      <span class="platform-chip__name">Todos</span>
      <span class="platform-chip__count">{totalCount}</span>
    </a>

    {latamPlatforms.map((platform) => (
      <a
        href={getFilterUrl(platform.id)}
        class:list={[
          'platform-chip',
          { 'platform-chip--active': selectedPlatform === platform.id },
          { 'platform-chip--empty': !hasContent(platform) },
        ]}
        style={`--platform-color: ${platform.color};`}
      >
        <span class="platform-chip__icon">{platform.icon}</span>
        <span class="platform-chip__name">{platform.shortName}</span>
        {hasContent(platform) && (
          <span class="platform-chip__count">{getCount(platform.id)}</span>
        )}
      </a>
    ))}
  </div>
</div>

<style>
  .platform-filter {
    padding: 1rem 0;
  }

  .platform-filter__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .platform-filter__title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--md-color-on-surface);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .platform-filter__icon {
    font-size: 1.25rem;
  }

  .platform-filter__count {
    font-size: 0.875rem;
    color: var(--md-color-primary);
    font-weight: 500;
  }

  .platform-filter__chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .platform-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    background: var(--md-color-surface-container-high);
    border: 1px solid var(--md-color-outline-variant);
    border-radius: 2rem;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--md-color-on-surface);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .platform-chip:hover {
    background: color-mix(in srgb, var(--platform-color, var(--md-color-primary)) 15%, var(--md-color-surface));
    border-color: var(--platform-color, var(--md-color-primary));
  }

  .platform-chip--active {
    background: var(--platform-color, var(--md-color-primary));
    border-color: var(--platform-color, var(--md-color-primary));
    color: white;
  }

  .platform-chip--active:hover {
    background: var(--platform-color, var(--md-color-primary));
  }

  .platform-chip--empty {
    opacity: 0.5;
    pointer-events: none;
  }

  .platform-chip__icon {
    font-size: 1rem;
  }

  .platform-chip__name {
    white-space: nowrap;
  }

  .platform-chip__count {
    font-size: 0.75rem;
    padding: 0.125rem 0.375rem;
    background: color-mix(in srgb, currentColor 15%, transparent);
    border-radius: 1rem;
  }

  .platform-chip--active .platform-chip__count {
    background: rgba(255, 255, 255, 0.2);
  }

  @media (max-width: 640px) {
    .platform-filter__chips {
      overflow-x: auto;
      flex-wrap: nowrap;
      padding-bottom: 0.5rem;
      margin: 0 -1rem;
      padding: 0 1rem 0.5rem;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .platform-filter__chips::-webkit-scrollbar {
      display: none;
    }

    .platform-chip {
      flex-shrink: 0;
    }
  }
</style>
