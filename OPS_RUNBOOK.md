# OPS Runbook: RSS Ingest Pipeline

## Overview

The RSS ingest pipeline fetches content from K-Pop and Korea-related RSS feeds, normalizes the data, deduplicates against recent items, and writes daily draft JSON files.

## Quick Start

```bash
# Run the ingest pipeline
pnpm ingest:rss

# Preview without writing files
pnpm ingest:rss --dry-run

# View draft statistics
pnpm ingest:rss --stats
```

## Where Drafts Appear

Drafts are written to:

```
data/drafts/YYYY-MM-DD/
├── article-slug-abc123def456.json
├── another-article-789ghi012jkl.json
└── ...
```

Each JSON file contains a single `DraftItem`:

```json
{
  "id": "bts-announces-world-tour-abc123def456",
  "source": {
    "name": "Soompi K-Pop",
    "url": "https://www.soompi.com/feed/kpop",
    "itemUrl": "https://www.soompi.com/article/123456"
  },
  "category": "kpop",
  "title": "BTS Announces World Tour",
  "summary": "BTS has announced dates for their upcoming world tour...",
  "publishedAt": "2025-12-15T10:30:00Z",
  "language": "es",
  "raw": {
    "guid": "soompi-123456",
    "link": "https://www.soompi.com/article/123456"
  }
}
```

## Categories

| Category | Content Type |
|----------|--------------|
| `kpop` | K-Pop news, artist updates, music releases |
| `korea_life` | Lifestyle, culture, food, trends |
| `korea_info` | General Korea news, politics, economy |

## RSS Sources

Current sources (see `scripts/ingest/sources.ts`):

- **K-Pop**: Soompi, AllKPop, KoreaBoo
- **Korea Life**: Korea Herald Lifestyle, Korea JoongAng Daily
- **Korea Info**: Korea Herald National, Yonhap News

## Daily Operations Checklist

### Morning Run

1. Run the pipeline:
   ```bash
   pnpm ingest:rss
   ```

2. Check the output summary:
   - `Fetched`: Total items from all feeds
   - `Deduplicated`: Items removed as duplicates
   - `Written`: New draft files created

3. If feeds failed, they'll retry on next run (graceful failure)

### Monitoring

```bash
# Check how many drafts exist
pnpm ingest:rss --stats

# List today's drafts
ls data/drafts/$(date +%Y-%m-%d)/

# Count drafts by day
find data/drafts -type f -name "*.json" | cut -d'/' -f3 | sort | uniq -c
```

### Troubleshooting

| Issue | Solution |
|-------|----------|
| All feeds failing | Check internet connectivity, wait and retry |
| Specific feed failing | Check if source changed URL, update `sources.ts` |
| Duplicate drafts appearing | Check `normalize.ts` deduplication logic |
| No new drafts | Normal if all items were duplicates |

## Deduplication Rules

Items are considered duplicates if within the last 7 days:

1. **Same URL**: Exact match on `source.itemUrl`
2. **Same Title**: Normalized title match (case-insensitive, punctuation removed)

## Testing

```bash
# Run normalize tests (slugify, dedupe)
pnpm test:ingest
```

## File Structure

```
scripts/ingest/
├── index.ts        # CLI entry point
├── sources.ts      # RSS feed configuration
├── types.ts        # TypeScript types
├── rss_fetch.ts    # Feed fetching
├── normalize.ts    # Normalization & deduplication
└── write_drafts.ts # File writing
```

## Adding New Sources

1. Edit `scripts/ingest/sources.ts`
2. Add new source to `RSS_SOURCES` array:
   ```typescript
   {
     name: "New Source Name",
     url: "https://example.com/rss",
     category: "kpop", // or korea_life, korea_info
   }
   ```
3. Run `pnpm ingest:rss --dry-run` to test

## Cron Setup (Optional)

For automated daily runs, add to crontab:

```bash
# Run at 6 AM daily
0 6 * * * cd /path/to/ondacoreana && pnpm ingest:rss >> logs/ingest.log 2>&1
```

## Recovery

If drafts are accidentally deleted:

1. Drafts can be regenerated by running ingest again
2. Deduplication only checks last 7 days
3. Older items will be re-fetched if still in RSS feeds
