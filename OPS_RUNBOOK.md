# OPS Runbook: Content Operations

## Table of Contents

1. [RSS Ingest Pipeline](#rss-ingest-pipeline)
2. [Content Quality Checks](#content-quality-checks)
3. [CI/CD Pipeline](#cicd-pipeline)
4. [Adding New RSS Sources](#adding-new-rss-sources)
5. [Adding Affiliate Products](#adding-affiliate-products)
6. [Troubleshooting](#troubleshooting)

---

# RSS Ingest Pipeline

## Overview

The RSS ingest pipeline fetches content from K-Pop and Korea-related RSS feeds, normalizes the data, deduplicates against recent items, and writes daily draft JSON files.

## Quick Start

```bash
# Run the ingest pipeline
pnpm ingest:rss

# Preview without writing files
pnpm ingest:rss --dry-run

# View draft statistics
pnpm ingest:rss --stats
```

## Where Drafts Appear

Drafts are written to:

```
data/drafts/YYYY-MM-DD/
‚îú‚îÄ‚îÄ article-slug-abc123def456.json
‚îú‚îÄ‚îÄ another-article-789ghi012jkl.json
‚îî‚îÄ‚îÄ ...
```

Each JSON file contains a single `DraftItem`:

```json
{
  "id": "bts-announces-world-tour-abc123def456",
  "source": {
    "name": "Soompi K-Pop",
    "url": "https://www.soompi.com/feed/kpop",
    "itemUrl": "https://www.soompi.com/article/123456"
  },
  "category": "kpop",
  "title": "BTS Announces World Tour",
  "summary": "BTS has announced dates for their upcoming world tour...",
  "publishedAt": "2025-12-15T10:30:00Z",
  "language": "es",
  "raw": {
    "guid": "soompi-123456",
    "link": "https://www.soompi.com/article/123456"
  }
}
```

## Categories

| Category | Content Type |
|----------|--------------|
| `kpop` | K-Pop news, artist updates, music releases |
| `korea_life` | Lifestyle, culture, food, trends |
| `korea_info` | General Korea news, politics, economy |

## RSS Sources

Current sources (see `scripts/ingest/sources.ts`):

- **K-Pop**: Soompi, AllKPop, KoreaBoo
- **Korea Life**: Korea Herald Lifestyle, Korea JoongAng Daily
- **Korea Info**: Korea Herald National, Yonhap News

## Daily Operations Checklist

### Morning Run

1. Run the pipeline:
   ```bash
   pnpm ingest:rss
   ```

2. Check the output summary:
   - `Fetched`: Total items from all feeds
   - `Deduplicated`: Items removed as duplicates
   - `Written`: New draft files created

3. If feeds failed, they'll retry on next run (graceful failure)

### Monitoring

```bash
# Check how many drafts exist
pnpm ingest:rss --stats

# List today's drafts
ls data/drafts/$(date +%Y-%m-%d)/

# Count drafts by day
find data/drafts -type f -name "*.json" | cut -d'/' -f3 | sort | uniq -c
```

### Troubleshooting

| Issue | Solution |
|-------|----------|
| All feeds failing | Check internet connectivity, wait and retry |
| Specific feed failing | Check if source changed URL, update `sources.ts` |
| Duplicate drafts appearing | Check `normalize.ts` deduplication logic |
| No new drafts | Normal if all items were duplicates |

## Deduplication Rules

Items are considered duplicates if within the last 7 days:

1. **Same URL**: Exact match on `source.itemUrl`
2. **Same Title**: Normalized title match (case-insensitive, punctuation removed)

## Testing

```bash
# Run normalize tests (slugify, dedupe)
pnpm test:ingest
```

## File Structure

```
scripts/ingest/
‚îú‚îÄ‚îÄ index.ts        # CLI entry point
‚îú‚îÄ‚îÄ sources.ts      # RSS feed configuration
‚îú‚îÄ‚îÄ types.ts        # TypeScript types
‚îú‚îÄ‚îÄ rss_fetch.ts    # Feed fetching
‚îú‚îÄ‚îÄ normalize.ts    # Normalization & deduplication
‚îî‚îÄ‚îÄ write_drafts.ts # File writing
```

## Adding New Sources

1. Edit `scripts/ingest/sources.ts`
2. Add new source to `RSS_SOURCES` array:
   ```typescript
   {
     name: "New Source Name",
     url: "https://example.com/rss",
     category: "kpop", // or korea_life, korea_info
   }
   ```
3. Run `pnpm ingest:rss --dry-run` to test

## Cron Setup (Optional)

For automated daily runs, add to crontab:

```bash
# Run at 6 AM daily
0 6 * * * cd /path/to/ondacoreana && pnpm ingest:rss >> logs/ingest.log 2>&1
```

## Recovery

If drafts are accidentally deleted:

1. Drafts can be regenerated by running ingest again
2. Deduplication only checks last 7 days
3. Older items will be re-fetched if still in RSS feeds

---

# Content Quality Checks

## Overview

The quality check system validates MDX content against editorial standards before publishing.

## Quick Commands

```bash
# Run quality check (threshold mode)
pnpm quality:check

# Run strict mode (fail on any violation)
pnpm quality:strict

# Set custom threshold
pnpm quality:check --threshold=10
```

## Validation Rules

| Rule | Severity | Description |
|------|----------|-------------|
| `title-length` | Error | Title must be >= 12 characters |
| `description-length` | Error | Description must be >= 50 characters |
| `noticias-source` | Warning | Noticias entries should have a `source` field |
| `kpop-tags` | Error | K-Pop entries must have at least 1 tag |
| `hero-image-alt` | Warning | Hero images need `heroImageAlt` for accessibility |
| `pub-date` | Error | All entries must have a `pubDate` field |
| `suspicious-content` | Warning | No raw timestamps, placeholder text, or TODO markers |

## Example Failure Output

```
üîç Content Quality Check
============================================================
Mode: THRESHOLD
Threshold: 5 violations max

üìÅ noticias/
----------------------------------------

  üìÑ new-article.mdx
     ‚ùå [title-length] Title too short: "News" (min 12 chars, got 4)
     ‚ùå [description-length] Description too short: 30 chars (min 50)
     ‚ö†Ô∏è [noticias-source] Noticias entries must have a 'source' field

============================================================

üìä Summary

   Files checked:  22
   Errors:         2
   Warnings:       1
   Total:          3

‚ùå Quality check FAILED

   Error count (2) exceeds threshold (5).

üí° Fix the errors above before proceeding.
```

## If Quality Check Fails

1. **Review the errors**: Check the file and rule name in the output
2. **Fix frontmatter**: Update the MDX file's YAML frontmatter
3. **Re-run check**: `pnpm quality:check`
4. **For warnings**: Fix or suppress with `--threshold` flag

### Common Fixes

| Error | Fix |
|-------|-----|
| Title too short | Write a more descriptive title (min 12 chars) |
| Description too short | Expand the meta description (min 50 chars) |
| Missing source | Add `source: "Source Name"` to frontmatter |
| Missing tags | Add `tags: ["tag1", "tag2"]` to frontmatter |
| Raw timestamp in body | Remove or format ISO dates properly |

---

# CI/CD Pipeline

## Workflow Overview

### On Pull Request (`ci.yml`)

1. **Lint**: Astro check for syntax errors
2. **Type Check**: TypeScript compilation check
3. **Tests**: Content validation, build tests, SEO tests
4. **Quality Check**: Content quality gates
5. **Build**: Full Astro build
6. **E2E Tests**: Playwright browser tests
7. **Security Scan**: Trivy vulnerability scan

### On Schedule (`scheduled-ingest.yml`)

- **Runs**: Daily at 6 AM UTC
- **Actions**: RSS ingest, quality check, log upload
- **Artifacts**: Ingest logs retained 30 days

## Manually Trigger Workflows

```bash
# Trigger CI manually
gh workflow run ci.yml

# Trigger ingest with dry-run
gh workflow run scheduled-ingest.yml -f dry_run=true

# View workflow runs
gh run list
```

## Artifacts

| Artifact | Retention | Contents |
|----------|-----------|----------|
| `build-output` | 7 days | Compiled `dist/` folder |
| `playwright-report` | 30 days | E2E test results |
| `trivy-results` | 7 days | Security scan report |
| `ingest-log-*` | 30 days | RSS ingest output |

---

# Adding New RSS Sources

## Step-by-Step

### 1. Find the RSS Feed URL

Common patterns:
- `/feed/` or `/rss/`
- `/feed.xml` or `/rss.xml`
- Check the site's footer or "Subscribe" links

### 2. Add to Sources Config

Edit `scripts/ingest/sources.ts`:

```typescript
export const RSS_SOURCES: RSSSource[] = [
  // ... existing sources ...

  // Add new source
  {
    name: "New Source Name",        // Display name
    url: "https://example.com/rss", // RSS feed URL
    category: "kpop",               // kpop | korea_life | korea_info
  },
];
```

### 3. Test the New Source

```bash
# Dry run to test without writing files
pnpm ingest:rss --dry-run
```

Check the output for:
- Feed fetched successfully (not in "failed" list)
- Items are being parsed correctly
- Titles are readable (no HTML entities)

### 4. Run Live

```bash
pnpm ingest:rss
```

### 5. Commit Changes

```bash
git add scripts/ingest/sources.ts
git commit -m "feat(ingest): add New Source Name RSS feed"
```

## Troubleshooting New Sources

| Issue | Cause | Solution |
|-------|-------|----------|
| HTTP 404 | Wrong URL | Verify URL in browser |
| HTTP 403 | Blocked by server | Try adding User-Agent header |
| Empty items | Non-standard RSS | Check XML structure manually |
| Garbled text | Encoding issue | Source may need special handling |

---

# Adding Affiliate Products

## Overview

Affiliate products are displayed via the `AffiliateBox` component based on the `affiliate_hint` frontmatter field.

## Supported Affiliate Hints

| Hint | Products Shown |
|------|----------------|
| `kpop_goods` | Albums, lightsticks, merch |
| `esim` | eSIM cards for Korea travel |
| `travel_insurance` | Travel insurance products |
| `streaming` | Streaming service subscriptions |
| `korean_learning` | Korean learning resources |

## Adding to Content

### 1. Add Hint to Frontmatter

```yaml
---
title: "Your Article Title"
description: "Article description..."
affiliate_hint: kpop_goods  # Add this line
---
```

### 2. Configure Products

Edit `src/components/affiliate/AffiliateBox.astro` to add new products:

```typescript
const AFFILIATE_PRODUCTS = {
  kpop_goods: [
    {
      name: "Product Name",
      url: "https://affiliate-link.com",
      image: "/images/affiliate/product.jpg",
      description: "Product description",
      price: "$XX.XX",
    },
  ],
  // ... other categories
};
```

### 3. Adding a New Category

1. Update the schema in `src/content/config.ts`:
   ```typescript
   affiliate_hint: z.enum([
     'kpop_goods',
     'esim',
     'travel_insurance',
     'streaming',
     'korean_learning',
     'new_category',  // Add here
   ]).optional(),
   ```

2. Add products to `AffiliateBox.astro`

3. Update this documentation

## Best Practices

- Use `affiliate_hint` sparingly (1 hint per article max)
- Match hint to article content naturally
- Disclose affiliate relationships per FTC guidelines
- Use `noAds: true` for articles that shouldn't show ads

---

# Troubleshooting

## Common Issues

### Build Fails

```bash
# Check for TypeScript errors
pnpm typecheck

# Check for Astro issues
pnpm lint

# Run tests
pnpm test
```

### Quality Check Fails

```bash
# See which files have issues
pnpm quality:check

# Fix or adjust threshold
pnpm quality:check --threshold=10
```

### RSS Ingest Issues

```bash
# Check feed status
pnpm ingest:rss --dry-run

# View stats
pnpm ingest:rss --stats
```

### E2E Tests Fail

```bash
# Run with UI for debugging
pnpm test:e2e:ui

# Check playwright report
open playwright-report/index.html
```

## Getting Help

1. Check this runbook first
2. Review error messages carefully
3. Check GitHub Actions logs
4. Open an issue if needed
